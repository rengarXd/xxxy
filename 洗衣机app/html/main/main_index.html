<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title>title</title>
		<link rel="stylesheet" type="text/css" href="../../css/Hui.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/fonts/iconfont.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/animate/animate.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/style.css"/>
		<style>
			.toast_top {
				background-color: #ffffcc;
				color: #ff6600;
			}
			/*.options {
			 height: 120px;
			 }*/
			.border-radius {
				border-radius: 70px;
				-webkit-border-radius: 15px;
			}
			.xyjd {
				background-color: #ff8bc8;
			}
			.smzf {
				background-color: #a0d468;
			}
			.yhhd {
				background-color: #59dbdb;
			}
			.iconfont {
				color: #b8b8b8;
			}
			.xy_border {
				border-bottom: 1px solid #f0f0f0;
				margin-left: 37px;
			}
			.touch {
				color: #666;
			}
		</style>
	</head>
	<body>
		<div class="H-text-list H-flexbox-horizontal toast_top H-vertical-middle" id="progress_toast" style="display: none;">
			<div class="H-flex-item H-font-size-12 H-padding-8 H-text-show-row-1">
				您正在使用的西三宿舍三楼西01机，大约<span id="mint"></span>后结束
			</div>
			<!--<span class="H-icon H-padding-horizontal-right-5 H-display-block"><i class="H-iconfont H-icon-arrow-right H-theme-font-color-white H-font-size-12 H-vertical-middle"></i></span>-->
		</div>
		<div class="H-flexbox-horizontal H-theme-background-color-white H-padding-vertical-both-20">
			<!--<div class="H-flex-item H-center-all options">
			<span class="border-radius H-icon H-display-block H-margin-horizontal-left-10 H-theme-font-color-white H-theme-background-color6 H-center-all" style="height: 70px; width: 70px;"><i class="iconfont icon-gerenxinxi H-font-size-20 H-vertical-middle wx_10aeff"></i></span>
			<strong class="H-font-size-12 H-display-block H-font-weight-normal H-margin-vertical-top-3">扫码支付</strong>
			</div>-->
			<div class="H-text-align-center H-flex-item H-padding-10" tapmode onclick="scanner();">
				<span class="smzf H-icon H-center-all H-border-radius-circle H-margin-horizontal-auto H-font-size-26 H-font-weight-600 H-theme-font-color-white" style="height: 59px; width: 59px; line-height:20px;"><img src="../../image/saoerweima.png" style="width: 30px;height: 30px;"/></span>
				<label class="H-display-block H-font-size-14 H-margin-vertical-top-5 xy_font_color">扫二维码</label>
			</div>
			<div class="H-text-align-center H-flex-item H-padding-10" tapmode onclick="openWin('progress_head','./progress/progress_head.html');">
				<span class="xyjd H-icon H-center-all  H-border-radius-circle H-margin-horizontal-auto H-font-size-26 H-font-weight-600 H-theme-font-color-white" style="height: 59px; width: 59px; line-height:20px;"><img src="../../image/xyprogress.png" style="width: 30px;height: 30px;"/></span>
				<label class="H-display-block H-font-size-14 H-margin-vertical-top-5 H-theme-font-color-666">洗衣进度</label>
			</div>
			<div class="H-text-align-center H-flex-item H-padding-10" tapmode onclick="openWin('discount_show_head','../order/discount/discount_show_head.html');">
				<span class="yhhd H-icon H-center-all H-border-radius-circle H-margin-horizontal-auto H-font-size-26 H-font-weight-600 H-theme-font-color-white" style="height: 59px; width: 59px; line-height:20px;"><img src="../../image/liwu.png" style="width: 30px;height: 30px;"/></span>
				<label class="H-display-block H-font-size-14 H-margin-vertical-top-5 H-theme-font-color-666">优惠活动</label>
			</div>
		</div>
		<div id="xyj_html">
			<div class="H-center-all H-padding-20">
				<img src="../../image/loading_more.gif" width="30" />
			</div>
		</div>
		<script type="text/html" id="xyj_data">
			<div class="H-theme-font-color-999 H-font-size-13 H-padding-vertical-both-3  animated fadeIn" style="padding-left: 30px;">
			您曾使用过的洗衣机
			</div>
			{{# for(var i = 0, len = d.length; i < len; i++) { }}
			<div class="H-theme-background-color-white H-margin-vertical-bottom-5">
			<div class="H-flexbox-horizontal  H-padding-vertical-top-10 ">
			<span class="H-padding-horizontal-both-10 "><i class="iconfont icon-xiyiji H-font-size-20 xy_font_color"></i></span>
			<div class="H-flex-item xy_font_color">
			<span>{{ d[i].device_name }}</span>
			{{# if(d[i].ustatus == "空闲") { }}
			<span class="H-float-right xyzt"  tapmode="H-touch-active" onclick="openProduct('{{ i }}');">我要洗衣</span>
			<div class="H-font-size-13 kongxian H-padding-vertical-both-3">
			空闲
			</div>
			{{# }else{ }}
			<span class="H-float-right xyzt">空闲提醒</span>
			<div class="H-font-size-13 beizhanyong H-padding-vertical-both-3">
			被占用
			</div>
			{{# } }}
			</div>
			<span class="H-icon H-padding-horizontal-right-10 H-display-block"><i class="iconfont icon-zhankai H-font-size-18 H-vertical-middle"></i> </span>
			</div>
			<div class="xy_border"></div>
			<div class="H-theme-background-color-white H-theme-font-color-999 H-font-size-13 H-padding-vertical-both-8" style="padding-left: 37px;">
			{{ d[i].washloca_name }}
			<span class="H-padding-horizontal-right-20 H-float-right">{{ d[i].distance }}米</span>
			</div>
			</div>
			{{# } }}
			<div class="H-text-align-center H-font-size-14 H-theme-font-color-999" tapmode="touch" onclick="openWin('nearby_laundry_head','./nearby_laundry/nearby_laundry_head.html');">
			查找更多洗衣点
			</div>
		</script>
		<script type="text/html" id="xyd_data">
			<div class="H-theme-font-color-999 H-font-size-13 H-padding-vertical-both-3" style="padding-left: 30px;">
			附近的洗衣点
			</div>
			{{# for(var i = 0, len = 3; i < len; i++) { }}
			<div class="H-theme-background-color-white H-margin-vertical-bottom-5 animated fadeIn" tapmode="H-touch-active" onclick="openXyj('{{ d[i].washloca_id }}','{{ d[i].distance }}');">
			<div class="H-flexbox-horizontal H-padding-vertical-top-10 ">
			<span class="H-padding-horizontal-both-10 "><i class="iconfont icon-xiyiji H-font-size-20 xy_font_color"></i></span>
			<div class="H-flex-item xy_font_color">
			<span>{{ d[i].washloca_name }}</span>
			</div>
			<span class="H-theme-font-color-999 H-icon H-padding-horizontal-right-10 H-display-block"><i class="iconfont icon-zhankai H-font-size-18 H-vertical-middle"></i> </span>
			</div>
			<div class="xy_border"></div>
			<div class="H-theme-background-color-white H-theme-font-color-999 H-font-size-13 H-padding-vertical-both-5" style="padding-left: 37px;">
			{{ d[i].washloca_address }} <span class="lanse">2台</span><span class="kongxian">空闲</span>
			<span class=" H-padding-horizontal-right-20 H-float-right">{{ d[i].distance }}米</span>
			</div>
			</div>
			{{# } }}
			<div class="H-text-align-center H-font-size-14 H-theme-font-color-999" tapmode="touch" onclick="openWin('nearby_laundry_head','./nearby_laundry/nearby_laundry_head.html');">
			查找更多洗衣点
			</div>
		</script>
		<script type="text/javascript" src="../../script/xy.js"></script>
		<script type="text/javascript" src="../../script/zepto.min.js"></script>
		<script type="text/javascript" src="../../script/tools/laytpl.js"></script>
		<script type="text/javascript">
			var longitude = null, latitude = null, isinerval = null, xyjdata = null;
			apiready = function() {
				api.parseTapmode();
				//获取位置信息
				getlocation();
				//下拉刷新
				api.setRefreshHeaderInfo({
					visible : true,
					bgColor : '#fff',
					textColor : '#666666',
					textDown : '下拉刷新...',
					textUp : '松开刷新...',
					showTime : true
				}, function(ret, err) {
					getlocation();
				});
				//监听事件
				listener();
			};
			//初始化数据方法
			function initData(longitude, latitude) {
				api.getPrefs({
					key : 'userinfo'
				}, function(ret, err) {
					//alert(JSON.stringify(user));
					if (ret && ret.value) {
						var user = eval('(' + ret.value + ')');
						$xy.ajax(function(ret, err) {
							api.refreshHeaderLoadDone();
							if (ret.success) {
								if (ret.data.length == 0) {
									$xy.ajax(function(ret, err) {
										api.refreshHeaderLoadDone();
										if (ret.success) {
											_tpl('xyd_data', ret.data, 'xyj_html', function() {
											});
										} else {
											$("#xyj_html").html('<div class="H-position-absolute H-position-center-all" id="statuss"><div class="H-font-size-14 H-text-align-center"><i class="iconfont icon-webiconxiyiji H-font-size-32 H-theme-font-color-999"></i><div class="H-theme-font-color-999">' + ret.message + '</div></div></div>')
										}
									}, 'getWashLoList&funid=wash_location&gps_longitude=' + longitude + '&gps_latitude=' + latitude);
								} else {
									xyjdata = ret.data;
									_tpl('xyj_data', xyjdata, 'xyj_html', function() {
									});
								}
							} else {
								api.refreshHeaderLoadDone();
								$("#xyj_html").html('<div class="H-position-absolute H-position-center-all" id="statuss"><div class="H-font-size-14 H-text-align-center"><i class="iconfont icon-webiconxiyiji H-font-size-32 H-theme-font-color-999"></i><div class="H-theme-font-color-999">服务器未响应</div></div></div>')
							}
						}, 'appUDeviceList&funid=wash_device&wash_user_id=' + user[0].wash_user_id + '&uuid=' + user[0].uuid + '&gps_longitude=' + +longitude + '&gps_latitude=' + latitude);
					} else {
						$xy.ajax(function(ret, err) {
							api.refreshHeaderLoadDone();
							if (ret) {
								if (ret.success) {
									_tpl('xyd_data', ret.data, 'xyj_html', function() {
									});
								} else {
									$("#xyj_html").html('<div class="H-position-absolute H-position-center-all" id="statuss"><div class="H-font-size-14 H-text-align-center"><i class="iconfont icon-webiconxiyiji H-font-size-32 H-theme-font-color-999"></i><div class="H-theme-font-color-999">' + ret.message + '</div></div></div>')
								}
							} else {
								api.toast({
									msg : '连接失败，请检查网络'
								});
							}
						}, 'getWashLoList&funid=wash_location&gps_longitude=' + longitude + '&gps_latitude=' + latitude);
					}
				});
			}

			//模板渲染
			//@tplId 模板循环部分DOM id 【string】
			//@renderData 模板部分数据 【JSON对象】
			//@tplDataId 模板被渲染部分DOM id 【string】
			//@callback 回调函数 【匿名函数】
			function _tpl(tplId, renderData, tplDataId, callback) {
				var tpl = document.getElementById(tplId).innerHTML;
				laytpl(tpl).render(renderData, function(render) {
					document.getElementById(tplDataId).innerHTML = render;
					callback();
				});
			}

			//打开洗衣点下的洗衣机
			function openXyj(washloca_id, distance_id) {
				api.openWin({
					name : 'nearby_machine_head',
					url : './nearby_laundry/nearby_machine_head.html',
					pageParam : {
						washloca_id : washloca_id,
						distance : distance_id
					},
					bounces : false,
					delay : 0,
					slidBackEnabled : true,
					vScrollBarEnabled : false,
					hScrollBarEnabled : false
				});
			}

			//打开页面方法
			function openWin(name, url) {
				api.openWin({
					name : name,
					url : url,
					delay : 0,
					bounces : false,
					slidBackEnabled : true,
					vScrollBarEnabled : false,
					hScrollBarEnabled : false
				});
			}

			//打开商品选项
			function openProduct(i) {
				api.openWin({
					name : 'option_head',
					url : './product/option_head.html',
					pageParam : {
						data : xyjdata[parseInt(i)]
					},
					delay : 0,
					slidBackEnabled : true,
					vScrollBarEnabled : false,
					hScrollBarEnabled : false
				});
			}

			//查找更多洗衣点
			//			function openLaundry() {
			//				api.openWin({
			//					name : 'nearby_laundry_head',
			//					url : './nearby_laundry/nearby_laundry_head.html',
			//					delay : 0,
			//					slidBackEnabled : true,
			//					vScrollBarEnabled : false,
			//					hScrollBarEnabled : false
			//				});
			//			}
			//获取位置信息
			function getlocation() {
				var systemType = api.systemType;
				if (systemType == "ios") {
					api.startLocation({
						accuracy : '10m',
						filter : 1,
						autoStop : true
					}, function(ret, err) {
						if (ret.status) {
							api.toast({
								msg : '获取位置成功'
							});
							//经度
							longitude = ret.longitude;
							//纬度
							latitude = ret.latitude;
							//初始化数据
							initData();
						} else {
							api.toast({
								msg : '获取位置失败'
							});
						}
					});
				} else {
					//初始化百度定位模块
					var baiduLocation = api.require('baiduLocation');
					//开始定位
					baiduLocation.startLocation({
						accuracy : '10m',
						filter : 1,
						autoStop : true
					}, function(ret, err) {
						if (ret.status) {
							api.toast({
								msg : '获取位置成功'
							});
							//经度
							longitude = ret.longitude;
							//纬度
							latitude = ret.latitude;
							//初始化数据
							initData(longitude, latitude);
						} else {
							api.toast({
								msg : '获取位置失败'
							});
						}
					});
				}
			}

			function scanner() {
				var FNScanner = api.require('FNScanner');
				//打开二维码扫描器
				FNScanner.openScanner(function(ret, err) {
					if (ret.content) {
						alert(ret.content);
					}
				});
			}

			//监听事件
			function listener() {
				//结束时间递减
				if (isinerval) {
					clearInterval(isinerval);
				}
				//倒计时提醒
				api.getPrefs({
					key : 'washtime'
				}, function(ret, err) {
					if (ret && ret.value) {
						//获取之前开始的时间
						var time = eval('(' + ret.value + ')');
						//获取当前时间
						var now = new Date();
						//计算剩余时间
						times = 300 - ((now.getTime() - parseInt(time)) / 1000);
						//调用倒计时方法
						isinerval = setInterval("CountDown()", 1000);
					} else {
						//隐藏提示条
						$("#progress_toast").hide();
					}
				});
			}

			//时间递减处理
			function CountDown() {
				//剩余时间
				var lasttime = parseInt(times / 60);
				var second = parseInt(times % 60);
				if (lasttime < 1) {
					document.getElementById('mint').innerHTML = second + '秒';
				} else {
					document.getElementById('mint').innerHTML = lasttime + '分钟';
				}
				$("#progress_toast").show();
				if (times < 1) {
					//结束时间递减
					clearInterval(isinerval);
					//隐藏提示条
					$("#progress_toast").hide();
					//移除偏好值
					api.removePrefs({
						key : 'washtime'
					});
					return;
				}
				times--;
			}
		</script>
	</body>
</html>