<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,initial-scale=1.0,width=device-width"/>
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>body</title>
		<link rel="stylesheet" type="text/css" href="../../../css/Hui.css" />
		<link rel="stylesheet" href="../../../css/style.css" />
		<link rel="stylesheet" href="../../../css/fonts/iconfont.css" />
		<style>
			.color-888 {
				color: #888888;
			}
			.color-22a5f9 {
				color: #22a5f9;
			}
		</style>
	</head>
	<body>
		<div class="H-padding-vertical-bottom-10"></div>
		<div class="H-padding-horizontal-both-20 H-padding-vertical-both-12 H-theme-background-color-white">
			<div class="H-flexbox-horizontal">
				<div class="H-flex-item H-font-size-20 H-theme-font-color-333" id="wash_title">
					---
				</div>
				<span class="H-font-size-13	H-vertical-middle"><span class="xyzt" id="movement_money">-.--</span>元</span>
			</div>
			<div class="color-888 H-font-size-12 H-padding-horizontal-left-2 H-padding-vertical-top-3" id="memo">
				----
			</div>
		</div>
		<div class="H-padding-horizontal-left-12 H-padding-vertical-both-5 H-font-size-12 color-888">
			请选择以下支付方式
		</div>
		<!--<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle H-touch-active">
		<div class="color-22a5f9 H-flex-item H-padding-horizontal-both-10 H-font-size-18 H-padding-vertical-both-12">
		18.00元
		</div>
		<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-13 color-888 H-padding-vertical-both-12">
		郑大南校定向余额
		</div>
		<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-13 color-888  H-padding-vertical-both-12"></div>
		<span class="H-icon H-padding-horizontal-right-10 H-display-block"><i class="iconfont icon-duihao H-theme-font-color-ccc H-font-size-26 H-vertical-middle"></i></span>
		</div>-->
		<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle H-touch-active" tapmode="H-touch-active" onclick="check(this);">
			<span class="zhifubao-bg-color H-icon H-center-all H-display-block H-margin-horizontal-left-10"><i class="iconfont icon-zhifubao H-font-size-18 H-vertical-middle H-theme-font-color-white"></i></span>
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-16 H-theme-font-color-333 H-padding-vertical-both-12">
				支付宝
			</div>
			<span class="H-icon H-padding-horizontal-right-10 H-display-block"><i  payway="1" class="iconfont payway H-theme-font-color-ccc H-font-size-26 H-vertical-middle"></i></span>
		</div>
		<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle H-touch-active" tapmode="H-touch-active" onclick="check(this);">
			<span class="weixin-bg-color H-icon H-center-all H-display-block H-margin-horizontal-left-10"><i class="iconfont icon-weixin H-font-size-18 H-vertical-middle H-theme-font-color-white"></i></span>
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-16 H-theme-font-color-333 H-padding-vertical-both-12">
				微信
			</div>
			<span class="H-icon H-padding-horizontal-right-10 H-display-block"><i payway="2" class="iconfont payway  H-theme-font-color-ccc H-font-size-26 H-vertical-middle"></i></span>
		</div>
		<div id="ptye_html" class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle H-touch-active" tapmode="H-touch-active" onclick="check(this);">
			<div class="H-flex-item H-padding-horizontal-both-15  H-padding-vertical-both-12">
				<span class="color-22a5f9 H-font-size-18" id="ptye">0.00元</span>
			</div>
			<div class="H-flex-item H-padding-horizontal-both-10  H-padding-vertical-both-12">
				<span class="H-font-size-13 color-888">普通余额</span>
			</div>
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-13 color-888  H-padding-vertical-both-12"></div>
			<span class="H-icon H-padding-horizontal-right-10 H-display-block H-vertical-middle"><i payway="3" class="iconfont payway H-theme-font-color-ccc H-font-size-26 "></i></span>
		</div>
		<div id="dxye_html"></div>
		<div class="H-padding-20">
			<button onclick="openCf();" class="xy_confirm_btn H-position-static H-button H-width-100-percent  H-font-size-15 H-border-none H-padding-vertical-both-12 H-padding-horizontal-both-20  H-theme-font-color-white ">
				确认支付
			</button>
		</div>
		<script type="text/html" id="dxye_data">
			{{# for(var i = 0, len = d.length;i<len;i++) { }}
			<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle H-touch-active" tapmode="H-touch-active" onclick="check(this,{{ i }});">
			<div class="color-22a5f9 H-flex-item H-padding-horizontal-both-15 H-font-size-18 H-padding-vertical-both-12">
			{{ d[i].user_sum }}元
			</div>
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-13 color-888 H-padding-vertical-both-12">
			{{ d[i].orientact_name }}
			</div>
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-13 color-888  H-padding-vertical-both-12"></div>
			<span class="H-icon H-padding-horizontal-right-10 H-display-block"><i payway="4" orientact_id="{{ d[i].orientact_id }}" uorientoverage_id="{{ d[i].uorientoverage_id }}" class="iconfont payway  H-theme-font-color-ccc H-font-size-26 H-vertical-middle"></i></span>
			</div>
			{{# } }}
		</script>
		<script type="text/javascript" src="../../../script/xy.js"></script>
		<script type="text/javascript" src="../../../script/zepto.min.js"></script>
		<script type="text/javascript" src="../../../script/tools/laytpl.js"></script>
		<script type="text/javascript">
			//	wash_user_id 用户id（必填）（string）
			//uuid  uuid（必填）（string）
			//device_id  洗衣机id  （必填）（string）
			//commodity_id 商品id（必填）（string）
			//pay_way 支付方式（必填）（string）（1、支付宝，2微信，3账户余额，4定向余额，5投币，6刷卡）
			//orientact_id 定向余额活动id（当支付方式为定向余额时必填）（string）
			//pay_num 支付金额（必填）（string）
			//origin_type 来源类型（必填）（string）（1、支付宝扫码；2、微信扫码；3、app扫码；4、app在线；5、投币；6、刷卡）
			//uorientoverage_id 用户定向余额Id
			//dxyeData  定向余额数据
			var order_id = null, ye_a = null, dxyeData = null, user = null, uorientoverage_id = null, orientact_id = null, device_id = null, commodity_id = null, pay_way = null, orientact_id = null, pay_num = null, origin_type = null;
			apiready = function() {
				//商品信息
				product = api.pageParam;
				console.log(JSON.stringify(product));
				//生成随机的订单号
				A();
				//初始化页面
				initPage();
			};
			//			Zepto(function($) {
			//				$(".icon-duihao").on("click", function(event) {
			//					$(".icon-duihao").hide();
			//					$(this).show();
			//				});
			//			});
			// 初始化页面
			function initPage() {
				//商品名称
				document.getElementById('wash_title').innerHTML = product.title;
				//商品备注
				document.getElementById('memo').innerHTML = product.memo;
				//商品价格
				document.getElementById('movement_money').innerHTML = product.movement_money;
				api.getPrefs({
					key : 'userinfo'
				}, function(ret, err) {
					if (ret && ret.value) {
						user = eval('(' + ret.value + ')');
						$xy.ajax(function(ret, err) {
							if (ret.success) {
								//普通余额
								ptyeAjax();
								//定向余额数据
								dxyeData = ret.data;
								_tpl('dxye_data', dxyeData, 'dxye_html', function() {
								});
							} else {
								api.toast({
									msg : ret.message
								});
							}
						}, 'appOverage&funid=wash_user_dxye' + '&wash_user_id=' + user[0].wash_user_id + '&uuid=' + user[0].uuid + '&device_id=' + product.device_id);
					} else {
						api.alert({
							title : '温馨提示',
							msg : '进行该操作前请先登录',
						}, function(ret, err) {
							if (ret.buttonIndex == 1) {
								api.openWin({
									name : 'login_body',
									url : '../../login/login_body.html'
								});
								setTimeout(function() {
									api.closeWin();
								}, 1000);
							}
						});
					}
				});
				//监听返回键
				api.addEventListener({
					name : 'keyback'
				}, function(ret, err) {
					api.closeWin();
				});
			}

			//普通余额请求
			function ptyeAjax() {
				$xy.ajax(function(ret, err) {
					if (ret) {
						//alert(JSON.stringify(ret));
						//普通余额
						account_overage = parseFloat(ret.data[0].account_overage);
						document.getElementById('ptye').innerHTML = ret.data[0].account_overage + '元';
						if (parseFloat(ret.data[0].account_overage) < parseFloat(product.movement_money)) {
							$('#ptye').css('color', '#999999');
						}
					} else {
						api.toast({
							msg : '请检查网络并刷新该页面'
						});
					}
				}, 'appUserInfo&funid=wash_user&wash_user_id=' + user[0].wash_user_id + '&uuid=' + user[0].uuid);
			}

			//模板渲染
			//@tplId 模板循环部分DOM id 【string】
			//@renderData 模板部分数据 【JSON对象】
			//@tplDataId 模板被渲染部分DOM id 【string】
			//@callback 回调函数 【匿名函数】
			function _tpl(tplId, renderData, tplDataId, callback) {
				var tpl = document.getElementById(tplId).innerHTML;
				laytpl(tpl).render(renderData, function(render) {
					document.getElementById(tplDataId).innerHTML = render;
					callback();
				});
			}

			//对应选项判断
			function check(obj, num) {
				$(".payway").removeClass('icon-duihao');
				$(obj).find(".payway").addClass('icon-duihao');
				pay_way = $(obj).find(".icon-duihao").attr("payway");
				if ($(obj).find(".icon-duihao").attr("orientact_id")) {
					//用户剩余的定向余额金额
					ye_a = parseFloat(dxyeData[num].user_sum);
					//商品总金额
					var tolal = parseFloat(product.movement_money);
					if (ye_a < tolal) {
						$('button').attr('onclick', 'paydxye();');
						//剩余支付金额
						last_money = tolal - ye_a;
					}
					orientact_id = dxyeData[num].orientact_id;
					//$(obj).find(".icon-duihao").attr("orientact_id");
					uorientoverage_id = dxyeData[num].uorientoverage_id;
					//$(obj).find(".icon-duihao").attr("uorientoverage_id");
				}
			}

			//定向余额+普通余额支付
			function paydxye(datas, callback) {
				//判断所剩余额是否够支付
				if (last_money > account_overage) {
					api.toast({
						msg : '余额不足，请充值或选择其他支付方式'
					});
					return;
				}
				orderid = "D" + A();
				api.showProgress();
				$xy.Pajax(function(ret, err) {
					api.hideProgress();
					if (ret) {
						//打开支付成功页;
						if (ret.success) {
							//执行main页面获取用户信息的函数
							api.execScript({
								name : 'main',
								script : 'initInfo();'
							});
							openResult(ret.data);
						} else {
							deleteOrder(orderid);
						}
						//openResult(ret.data);
					} else {
						alert("err====" + err.message);
					}
				}, 'addOrderOrient&funid=wash_order', 'post', {
					values : {
						wash_user_id : user[0].wash_user_id,
						uuid : user[0].uuid,
						device_id : product.device_id, //洗衣机id  （必填）（string）
						commodity_id : product.commodity_id, //商品id（必填）（string）
						pay_way : '4', //支付方式
						pay_num : ye_a, //用户定向余额的金额
						pay_way1 : '3', //普通余额支付方式
						pay_num1 : last_money, //剩余支付金额
						orientact_id : orientact_id, //定向余额活动id（当支付方式为定向余额时必填）（string）
						uorientoverage_id : uorientoverage_id, //用户定向余额Id
						origin_type : '4', //来源
						order_id : orderid//订单号
					}
				});
			}

			function openCf() {
				if (!pay_way) {
					api.toast({
						msg : '请先选择支付方式'
					});
					return;
				};
				if (pay_way == 1) {
					orderid = "A" + A();
					doPay({
						wash_user_id : user[0].wash_user_id,
						uuid : user[0].uuid,
						device_id : product.device_id, //洗衣机id  （必填）（string）
						commodity_id : product.commodity_id, //商品id（必填）（string）
						pay_way : pay_way, //支付方式
						pay_num : product.movement_money, //支付金额
						origin_type : '4', //来源
						order_id : orderid//订单号
					}, function(ret, err) {
						order_no = ret.data;
						if (ret.success) {
							//支付宝支付方法
							alipayFunction(order_no, orderid);
						} else {
							if (ret.message) {
								api.toast({
									msg : ret.message
								});
							} else {
								api.toast({
									msg : '服务器未响应，支付失败'
								});
							}
						}
					});
				} else if (pay_way == 2) {
					orderid = "W" + A();
					//打开支付成功页;
					doPay({
						wash_user_id : user[0].wash_user_id,
						uuid : user[0].uuid,
						device_id : product.device_id, //洗衣机id  （必填）（string）
						commodity_id : product.commodity_id, //商品id（必填）（string）
						pay_way : pay_way, //支付方式
						pay_num : product.movement_money, //支付金额
						origin_type : '4', //来源
						order_id : orderid//订单号
					}, function(ret, err) {
						order_no = ret.data;
						if (ret.success) {
							//微信支付
							wxPayFunction(order_no, orderid);
						} else {
							if (ret.message) {
								api.toast({
									msg : ret.message
								});
							} else {
								api.toast({
									msg : '服务器未响应，支付失败'
								});
							}
						}
					});
				} else if (pay_way == 3) {
					//判断普通余额
					if (parseFloat(product.movement_money) > account_overage) {
						api.toast({
							msg : '余额不足，请充值或选择其他支付方式'
						});
						return;
					}
					orderid = "P" + A()
					doPay({
						wash_user_id : user[0].wash_user_id,
						uuid : user[0].uuid,
						device_id : product.device_id, //洗衣机id  （必填）（string）
						commodity_id : product.commodity_id, //商品id（必填）（string）
						pay_way : pay_way, //支付方式
						pay_num : product.movement_money, //支付金额
						origin_type : '4', //来源
						order_id : orderid//订单号
					}, function(ret, err) {
						//打开支付成功页;
						if (ret.success) {
							//执行main页面获取用户信息的函数
							api.execScript({
								name : 'main',
								script : 'initInfo();'
							});
							openResult(ret.data);
						} else {
							deleteOrder(orderid);
						}
					});
				} else if (pay_way == 4) {
					orderid = "D" + A();
					doPay({
						wash_user_id : user[0].wash_user_id,
						uuid : user[0].uuid,
						device_id : product.device_id, //洗衣机id  （必填）（string）
						commodity_id : product.commodity_id, //商品id（必填）（string）
						pay_way : pay_way, //支付方式
						pay_num : product.movement_money, //支付金额
						orientact_id : orientact_id, //定向余额活动id（当支付方式为定向余额时必填）（string）
						uorientoverage_id : uorientoverage_id, //用户定向余额Id
						origin_type : '4', //来源
						order_id : orderid//订单号
					}, function(ret, err) {
						//打开支付成功页;
						if (ret.success) {
							openResult(ret.data);
						} else {
							deleteOrder(orderid);
						}
					});
				}
			}

			//删除订单方法
			function deleteOrder(orderid) {
				$xy.ajax(function(ret, err) {
					if (ret.success) {
						api.toast({
							msg : ret.message
						});
						setTimeout(function() {
							api.closeWin();
						}, 800);
					} else {
						if (ret.message) {
							api.toast({
								msg : ret.message
							});
						} else {
							api.toast({
								msg : '服务器未响应，支付失败'
							});
						}
					}
				}, 'deleteOrder&funid=wash_order&wash_user_id=' + user[0].wash_user_id + '&uuid=' + user[0].uuid + '&order_id=' + orderid);
			}

			//支付方法
			function doPay(datas, callback) {
				api.showProgress();
				$xy.Pajax(function(ret, err) {
					api.hideProgress();
					if (ret) {
						//打开支付成功页;
						callback(ret, err);
						//openResult(ret.data);
					} else {
						alert("err====" + err.message);
					}
				}, 'addOrder&funid=wash_order', 'post', {
					values : datas
				});
				//				api.getPrefs({
				//					key : 'washtime'
				//				}, function(ret, err) {
				//					if (ret && ret.value) {
				//
				//					} else {
				//						//初始化所用时间
				//						api.toast({
				//							msg : '您已经在洗衣服了，请耐心等待洗衣结束'
				//						});
				//					}
				//				});
			}

			//支付宝支付方法
			function alipayFunction(order_no, orderid) {
				var obj = api.require('aliPay');
				var aliPayurl = window.aliPayurl;
				obj.config({
					partner : '2088421786244385',
					seller : 'jiyou360@126.com',
					rsaPriKey : 'MIICdgIBADANBgkqhkiG9w0BAQEFAASCAmAwggJcAgEAAoGBAMnRFvabENOHewFvPz4zTLVRG/7hyq8oDcsa+Qw2Wve7bHhSQP/jZPb7gRjiilEKUUtADXqZq1WcllEebVrSapcQrpX3kYlhhdGiSGhGyZRy018UieG3dqvQGXa/3ktqbBKcD3Uqr/1W+5pyNa1g4ABCYWG7/NA8PLMgrjgN/bXZAgMBAAECgYAH6HGF6D2YjE59l+ZagZgX4r2+FwriIieoNb5chCS8YFO3w0FYxYhHRUOhvf69fjIBSNk+XJciG6ioNRED5grXHrJPIfcCIQYOpX0JEb0NhG/jpyOaCHxXKNGjij9qhJFUnmAH6At28N9YX02HZJBZPgx8P1UaOfvlmUxHFrmXIQJBAO73n8/gjFGg0i3lh9tjU/0cb7bdxrgSVovW+nFdMqRGQuNbKbTjjTUQ3PCZ8l5oYUcFI9JaZ/BJyEyhpFsO8ZMCQQDYM5bTV0JxLAJKjH2mmin7KCwSx+bAjQqVhqL/QZ5bsg302fLt4t6NwFknsvz+gWjpPoFR+S4rcCromOZXJs5jAkApxLBzRj1geyqhiRARAbCJejHwlZ0JSXNFKANIU1Dps7o3QRTuICPrVZI4n7/kTnxKTJSxTMoEDvFqq4otvFPvAkBoQliVihrsYICqWp2tXeKoz3KRi/znFhzohojL92Taaz73uLLBrQoN6ZgU4OfIA7gH4rCSS0vMfsbya+mIVZppAkEA5rhmaQ9RCbpcPcd+3jqLpIQtbXrKhsc3YRKtWpH06l2BKG8dDjey9ecLCp/UYWCObSLSvWhNg/1gxaVlAgRUDQ==',
					rsaPubKey : 'MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDJ0Rb2mxDTh3sBbz8+M0y1URv+4cqvKA3LGvkMNlr3u2x4UkD/42T2+4EY4opRClFLQA16matVnJZRHm1a0mqXEK6V95GJYYXRokhoRsmUctNfFInht3ar0Bl2v95LamwSnA91Kq/9VvuacjWtYOAAQmFhu/zQPDyzIK44Df212QIDAQAB',
					notifyURL : aliPayurl,
				}, function(ret, err) {
					if (ret.status) {
						obj.pay({
							subject : product.title,
							body : product.memo,
							amount : product.movement_money,
							tradeNO : orderid
						}, function(ret, err) {
							//1.0 如果支付宝提示付款成功！
							if (ret && ret.statusCode == 9000) {
								openResult(order_no);
							} else {
								deleteOrder(orderid);
							}
						});
					} else {
						deleteOrder(orderid);
					}
				});
			}

			function wxPayFunction(order_no, orderid) {
				var wxPay = api.require('wxPay');
				var wxPayurl = window.wxPayurl;
				wxPay.config({
					apiKey : 'wx563cde637c901097',
					mchId : '1390880602',
					partnerKey : 'nZ9booT9pQOaIGp5hcrjMs243GPvS7g4',
					notifyUrl : wxPayurl
				}, function(ret, err) {
					if (ret.status) {
						//alert('配置商户支付参数成功');
						var jiage = parseFloat(product.movement_money) * 100;
						//alert(jiage);
						//deleteOrder(orderid);
						wxPay.pay({
							description : product.title,
							totalFee : String(jiage),
							tradeNo : orderid
						}, function(ret, err) {
							if (ret.status) {
								//alert(ret.result);
								//打开支付成功页;
								openResult(order_no);
							} else {
								alert(JSON.stringify(err));
								deleteOrder(orderid);
							}
						});
					} else {
						alert(err.code);
						deleteOrder(orderid);
					}
				});
			}

			//支付成功结果
			function openResult(result) {
				api.openWin({
					name : 'pay_result_head',
					url : 'pay_result_head.html',
					pageParam : {
						data : result
					},
					bounces : false,
					delay : 300,
					slidBackEnabled : true,
					vScrollBarEnabled : false
				});
				setTimeout(function() {
					api.closeWin();
				}, 800);
			}

			//生成随机订单号
			function A() {
				var date = new Date();
				var seperator1 = "-";
				var year = date.getFullYear();
				var month = date.getMonth() + 1;
				var strDate = date.getDate();
				var hour = date.getHours();
				var minutes = date.getMinutes();
				var seconds = date.getSeconds();
				if (month >= 1 && month <= 9) {
					month = "0" + month;
				}
				if (strDate >= 0 && strDate <= 9) {
					strDate = "0" + strDate;
				}
				if (hour >= 0 && hour <= 9) {
					hour = "0" + hour;
				}
				if (minutes >= 0 && minutes <= 9) {
					minutes = "0" + minutes;
				}
				if (seconds >= 0 && seconds <= 9) {
					seconds = "0" + seconds;
				}
				var currentdate = year + month + strDate + hour + minutes + seconds + parseInt((Math.random()) * 10000);
				return currentdate;
				//alert(currentdate);
			}
		</script>
	</body>
</html>