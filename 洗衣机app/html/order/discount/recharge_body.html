<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
        <title>充值body</title>
        <link rel="stylesheet" type="text/css" href="../../../css/Hui.css" />
        <link rel="stylesheet" href="../../../css/fonts/iconfont.css" />
        <style>
            html, body {
                background: #F0F0F0
            }
            .H-border-vertical-bottom-after:after {
                border-bottom: 1px solid #F0F0F0 !important;
            }
            .bg_1 {
                background: #FFFFFF
            }
          
            .b_czbutton {
                width: 33.333%;
                float: left;
                text-align: center;
            }
            .p_active{
                background-image: url('../../../image/p_type_active.jpg');
                background-repeat: no-repeat;
                background-position: bottom right;
            }
        </style>
    </head>
    <body>
        <div class="H-flexbox-vertical">
            <div class="H-flexbox-horizontal H-border-vertical-bottom-after H-padding-25" style="background: #f44848">
                <div class="H-center-all H-flex-item">
                    <span class="H-font-size-28" style="color: #ffffff;" id="yue">￥0.00</span>
                </div>
            </div>
            <!--
            <div class="H-vertical-align-middle H-vertical-middle H-padding-horizontal-left-10 H-font-size-15" style="height: 32px;">
            冻结金额<span class=" H-float-right H-text-align-right H-vertical-middle" style="color: #FF6600;padding-left: 245px;">0.00</span>
            </div>
            <div class="H-vertical-align-middle H-vertical-middle H-padding-horizontal-left-10 H-font-size-15" style="height: 32px;">
            可用金额<span class=" H-float-right H-text-align-right H-vertical-middle" style="color: #FF6600;padding-left: 245px;">0.00</span>
            </div>-->
            <div style="background: #F0F0F0;height: 10px;"></div>
            <div class="H-vertical-middle H-padding-horizontal-left-10 H-font-size-15 H-border-vertical-bottom-after H-theme-background-color-white H-padding-10">
                请选择充值余额
            </div>
            <div class="H-border-vertical-bottom-after H-padding-10 H-theme-background-color-white" id="czcl_body">
                <!--加载进度-->
                <!--<div class="H-text-align-center">
                    <img src="../../../image/loading01.gif" />
                </div>-->
                <!--加载进度-->
            </div>
            <!--            <div class="H-center-all H-font-size-12 H-padding-10 H-theme-background-color-white H-theme-font-color-999">
            充100送10元，多充多送
            </div>
            -->
            <div style="background: #F0F0F0;height: 10px;"></div>
            <div class="H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle H-padding-horizontal-left-10 H-font-size-15" style="height: 40px;">
                支付方式
            </div>
            <!--
            <div class="H-flexbox-horizontal H-theme-background-color-white H-padding-vertical-both-8 H-border-vertical-bottom-after">
            <div class="H-padding-horizontal-left-15 H-padding-horizontal-right-15" style="width: 30px"><i class="iconfont icon-weixinzhifu H-font-size-30 H-theme-font-color9"></i></div>
            <div class="H-flex-item H-padding-vertical-top-3">
            <div class="H-font-size-14">微信支付</div>
            <div class="H-font-size-12"> 推荐安装微信5.0及以上版本的使用</div>
            </div>
            <div class=" H-padding-horizontal-right-15" style="width: 30px;">
            <input type="radio" name="h" class="H-radio H-radio-fill H-vertical-align-middle H-font-size-18 H-theme-font-color9 H-float-right H-border-radius-circle H-margin-vertical-top-12 H-margin-horizontal-left-8">
            </div>
            </div>-->
            <div class="H-flexbox-horizontal H-theme-background-color-white H-padding-vertical-both-8">
                <div class="H-padding-horizontal-left-15 H-padding-horizontal-right-15" style="width: 30px">
                    <i class="iconfont icon-zhifubao H-font-size-30" style="color: #00ACF3;"></i>
                </div>
                <div class="H-flex-item H-padding-vertical-top-3">
                    <div class="H-font-size-14">
                        支付宝支付
                    </div>
                    <div class="H-font-size-12">
                        推荐有支付宝账户的用户使用
                    </div>
                </div>
                <div class=" H-padding-horizontal-right-15" style="width: 30px;">
                    <input type="radio" name="h" checked="checked" class="H-radio H-radio-fill H-vertical-align-middle H-font-size-18 H-theme-font-color9 H-float-right H-border-radius-circle H-margin-vertical-top-12 H-margin-horizontal-left-8">
                </div>
            </div>
        </div>
        <div style="background: #F0F0F0;height: 10px;"></div>
        <div tapmode="" onclick="do_pay();" class="H-button H-font-size-16 H-center-all H-border-radius-8 H-margin-horizontal-both-15 H-touch-active" style="background: #FF6600;color: #FFFFFF;height: 40px;">
            去充值
        </div>
        <div class="H-flexbox-horizontal H-font-size-12 H-horizontal-center H-margin-vertical-top-15" style="color: #C5C5C5;">
            点击立即充值，即表示您同意<span style="color: #6EADEE;">《充值协议》</span><br />
            充值以后，账户余额不能提现、转增、退还
        </div>
        <!--充值策略循环体-->
        <script id="clzl_item" type="text/html">
            {{# for(var i=0,l=d.length;i<l;i++){ }}
            {{# if(i == 0){ }}
            <div class="H-font-size-14 b_czbutton" tapmode onclick="choase(this,{{= d[i].money }});">
            <div class="H-border-both H-theme-border-color7" style="margin: 4px">
            {{# }else{ }}
            <div class="H-font-size-14 b_czbutton" tapmode onclick="choase(this,{{= d[i].money }});">
            <div class="H-border-both" style="margin: 4px">
            {{# } }}
            {{ d[i].money }}元
            <br />
            <span class="H-theme-font-color-999 H-font-size-10">赠送{{ d[i].give_money }}元</span>
            </div>
            </div>
            {{# } }}
        </script>
        <!--充值策略循环体-->
    </body>
    <script type="text/javascript" src="../../../script/api.js"></script>
    <script type="text/javascript" src="../../../script/common.js"></script>
    <script type="text/javascript" src="../../../script/zepto.min.js"></script>
    <script type="text/javascript" src="../../../script/laytpl.js"></script>
    <script type="text/javascript">
        var paymoney = 100;
        var obj = null;
        apiready = function() {
            api.parseTapmode();
            //打开model
            initModel();
            //初始化页面
            initPage();
        }
        //页面初始化
        function initPage() {
            api.getPrefs({
                key : 'userCenter'
            }, function(ret, err) {
                //console.log("coupon==" + JSON.stringify(ret));
                if (ret && ret.value) {
                    var userCenterInfo = eval('(' + ret.value + ')');
                    //用户余额
                    $('#yue').text("￥" + userCenterInfo.purse_balance);
                    //获取用户充值策略的数据
                    initgetUserRechargeDiscount();
                    //获取中心信息，刷新页面
                    nowUserCenter();
                } else {
                    userCenter();
                }
            });
        }

		//获取中心信息，刷新页面
		function nowUserCenter() {
			$bd.ajax(function(ret, err) {
				if (ret) {
					switch (ret.retCode) {
						case 0:
							user_coupon_count = ret.retValue.user_coupon_count;
							purse_balance = ret.retValue.user_purse_balance.purse_balance;
							avatar = ret.retValue.user_purse_balance.avatar;
							//用户余额
							$('#yue').text("￥" + purse_balance);
							var userCenters = {
								'user_coupon_count' : user_coupon_count,
								'purse_balance' : purse_balance,
								'avatar' : avatar
							};
							api.setPrefs({
								key : 'userCenter',
								value : JSON.stringify(userCenters)
							});
							break;
						case 1:
							break;
					}
				} else {
					if (err && err.code == 0) {
						api.toast({
							msg : err.msg
						});
					}
				}
			}, 'getUserCenter');
		}

		//获取中心信息，存入偏好值
		function userCenter() {
			$bd.ajax(function(ret, err) {
				if (ret.retCode == 0) {
					user_coupon_count = ret.retValue.user_coupon_count;
					purse_balance = ret.retValue.user_purse_balance.purse_balance;
					avatar = ret.retValue.user_purse_balance.avatar;
					var userCenters = {
						'user_coupon_count' : user_coupon_count,
						'purse_balance' : purse_balance,
						'avatar' : avatar
					};
					api.setPrefs({
						key : 'userCenter',
						value : userCenters
					});
				}
			}, 'getUserCenter');
		}
        
        //选择钱数的处理
		function choase(obj, money) {
			paymoney = money;
			$(obj).parent().children().children().removeClass("H-theme-border-color7 p_active");
			$(obj).children().addClass("H-theme-border-color7 p_active");
		}
        
        //初始化用户金额
		function initgetUserRechargeDiscount() {
			$bd.ajax(function(ret, err) {
				api.parseTapmode();
				var tpl = document.getElementById('clzl_item').innerHTML;
				laytpl(tpl).render(ret.retValue, function(render) {
					$api.html($api.byId("czcl_body"), render);
				});
			}, 'getUserRechargeDiscount');
		}

		//初始化模型
		function initModel() {
			obj = api.require('aliPay');
		}

		//充值
		function do_pay() {
			api.showProgress({
			     title:"",
			     text:""
			});
			//生成唯一订单号
			var myDate = new Date();
			tradeNO = 'CZ_TRADENO' + myDate.getFullYear() + myDate.getMonth() + myDate.getDate() + myDate.getHours() + myDate.getMinutes() + myDate.getSeconds() + RndNum(6);
			//提交订单
			$bd.ajax(function(ret, err) {
				var order_data = ret;
				//配置支付信息
				obj.config({
					partner : '2088221727149058',
					seller : 'zzwecool@qq.com',
					rsaPriKey : 'MIICdgIBADANBgkqhkiG9w0BAQEFAASCAmAwggJcAgEAAoGBAJulzg4zKqdWsSRgQKfY3nhVHVQv7Y2vuhQj0N+1isAXhUt6bi9XbGe0Hws04YR5YQ5EdjdnOrKKaMEs1MVuIcC06TCc6ibeKk3+hTL54Zud34WKxD+Z2Lofws5e/aBZ+NkfJwda92oeqlPBZaA40xVpPmMAQFoT/QdMoyo465K7AgMBAAECgYBEPCUgjoflgpj4JIZTzzyArnfEH5raIa7HA4ifelwQqH8UPuEtOftZX1q4s/8l73yAH71fvo66FPmlrny87PI4dTpNUS0lywI1QdvY1MSXSjjgRDQLaGCRjxDhU+DER/TTqr71QTh2YUMxWh2o7jOOexBC+TfUctL2M0mVT1zReQJBAM4q2wLdUKFsh4K/IoLFE9w8tM6USSYtJviIFv/fj+t9GVzxqXxSeX9+dII9vlPw7QXDvhKW0SZqyHqbuIaGSTcCQQDBROjkgkPgV5ciR0GwWNfaJ84h8snaM1TtanQuflHu5ZIEbHxCzEFlP+60BbhbFRCVdXnaHWykHtuMnIHOmrSdAkEAhXey/yC9gTNcauVH9zaUi+B1AMN4s5FJiF253f4iEsaS89uy6DwQUdxQmrxUCc2P9EprM2eVkPRSQyWqiNRIcwJAWcwcsV9dDjVkQUb+XGNLF097VQarhrhm81CM3rVOeEMuDuQg8CBbGiIUVIx71cX5yJemoBMf0TmNJM3q+gWjeQJAXyZuB2geym7EZsq+Xh2fNQ5Z1QKQrnkb6Lfs23/hgQ9Dby2O1iBA+XOwEQ7Wd99ZWy2oCSpZF4HGjPeF5euXBA==',
					rsaPubKey : 'MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCbpc4OMyqnVrEkYECn2N54VR1UL+2Nr7oUI9DftYrAF4VLem4vV2xntB8LNOGEeWEORHY3ZzqyimjBLNTFbiHAtOkwnOom3ipN/oUy+eGbnd+FisQ/mdi6H8LOXv2gWfjZHycHWvdqHqpTwWWgONMVaT5jAEBaE/0HTKMqOOuSuwIDAQAB',
					notifyURL : 'http://218.29.85.102/BDserverSVN/index.php/Api/V1/userAlipayPay',
				}, function(ret, err) {
					if (ret.status)
						api.hideProgress();
					obj.pay({
						subject : '在线充值',
						body : "在线充值" + paymoney + "元",
						amount : paymoney,
						tradeNO : tradeNO
					}, function(ret, err) {
						api.hideProgress();
						//1.0 如果支付宝提示付款成功！
						if (ret && ret.statusCode == 9000) {
							//1.请求接口检验
							//2.发出通知
							$bd.ajax(function(ret, err) {
								//console.log(JSON.stringify(ret));
								if (ret.retCode == 0) {
									api.toast({
										msg : '恭喜充值成功！'
									});
									window.location.reload();
									execScriptReload();
								}
							}, 'userAlipayPayConfirm/voucher_no/' + tradeNO);
						} else {
							api.alert({
								title : '支付失败提醒',
								msg : "抱歉支付未成功"
							}, function(ret, err) {
								if (ret.buttonIndex == 1) {
									api.closeWin({
									});
								}
							});
						}
					});
				});
			}, 'createUser_recharge', {
				"voucher_no" : tradeNO, //商户唯一订单
				"recharge_amount" : 0.01 //充值金额
			});
		}

		//随机数函数
		function RndNum(n) {
			var rnd = "";
			for (var i = 0; i < n; i++)
				rnd += Math.floor(Math.random() * 10);
			return rnd;
		}

		//刷新其他页面
		function execScriptReload() {
			var  jsfun = 'menuleftReload();';
			api.execScript({
				name : 'menuleft',
				script : jsfun
			});
		}
	</script>
</html>