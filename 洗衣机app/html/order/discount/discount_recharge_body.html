<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,initial-scale=1.0,width=device-width" />
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>优惠活动充值body</title>
		<link rel="stylesheet" type="text/css" href="../../../css/Hui.css" />
		<link rel="stylesheet" href="../../../css/style.css" />
		<link rel="stylesheet" href="../../../css/fonts/iconfont.css" />
		<style>
			.color-888 {
				color: #888888;
			}
			.color-22a5f9 {
				color: #22a5f9;
			}
			.color-ff6600 {
				color: #ff6600;
			}
			.color-555555 {
				color: #555555;
			}
			.b_czbutton {
				width: 33.333%;
				float: left;
				text-align: center;
			}
			.p_active {
				background-image: url('../../../image/p_type_active.jpg');
				background-repeat: no-repeat;
				background-position: bottom right;
			}
			.xy_border {
				border-bottom: 1px solid #d8d8d8;
				margin-left: 10px;
				margin-right: 10px;
			}
		</style>
	</head>
	<body>
		<div class="H-padding-vertical-bottom-10"></div>
		<div class="H-padding-12 H-theme-background-color-white">
			<div class="H-center-all color-888 H-font-size-12 H-padding-horizontal-left-2 H-padding-vertical-top-3">
				<span>适用范围：</span><span id="dept_name"></span>
			</div>
			<div class="xy_border H-padding-vertical-top-10"></div>
			<div class="H-flexbox-horizontal H-margin-vertical-top-10 H-text-align-center">
				<div class="H-flex-item H-font-size-12 color-888 ">
					<div class="H-flexbox-vertical">
						<div class="color-555555" style="font-size: 15px;">
							充值金额
						</div>
						<div class="color-22a5f9" style="font-size: 30px;" id="recharge_pay">
							0.00
						</div>
					</div>
				</div>
				<div class=" H-flex-item H-font-size-12 color-888">
					<div class="H-flexbox-vertical">
						<div class="color-555555" style="font-size: 15px;">
							赠送金额
						</div>
						<div class="color-ff6600" style="font-size: 30px;" id="presentation_pay">
							0.00
						</div>
					</div>
				</div>
			</div>
		</div>
		<div style="background: #F0F0F0;height: 10px;"></div>
		<div class="H-vertical-middle H-padding-horizontal-left-10 H-font-size-15 H-border-vertical-bottom-after H-theme-background-color-white H-padding-10">
			请选择充值余额
		</div>
		<div class="H-border-vertical-bottom-after H-padding-10 H-theme-background-color-white" id="clzl_list">
			<!--加载进度-->
			<!--<div class="H-text-align-center">
			<img src="../../../image/loading01.gif" />
			</div>-->
			<!--加载进度-->
		</div>
		<div style="background: #F0F0F0;height: 10px;"></div>
		<div class="H-vertical-middle H-padding-horizontal-left-10 H-font-size-15 H-border-vertical-bottom-after H-theme-background-color-white H-padding-10">
			请选择支付方式
		</div>
		<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle H-touch-active" tapmode="H-touch-active" onclick="check(this);">
			<span class="zhifubao-bg-color H-icon H-center-all H-display-block H-margin-horizontal-left-10"><i class="iconfont icon-zhifubao H-font-size-18 H-vertical-middle H-theme-font-color-white"></i></span>
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-16 H-padding-vertical-both-12">
				支付宝
			</div>
			<span class="H-icon H-padding-horizontal-right-10 H-display-block"><i payway="1" class="iconfont icon-duihao payway H-theme-font-color-ccc H-font-size-26 H-vertical-middle"></i></span>
		</div>
		<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle H-touch-active" tapmode="H-touch-active" onclick="check(this);">
			<span class="weixin-bg-color H-icon H-center-all H-display-block H-margin-horizontal-left-10"><i class="iconfont icon-weixin H-font-size-18 H-vertical-middle H-theme-font-color-white"></i></span>
			<div class="H-flex-item H-padding-horizontal-both-10  H-font-size-16 H-padding-vertical-both-12">
				微信支付
			</div>
			<span class="H-icon H-padding-horizontal-right-10 H-display-block"><i payway="2" class="iconfont payway H-theme-font-color-ccc H-font-size-26 H-vertical-middle"></i></span>
		</div>
		<!--<div class="H-padding-horizontal-left-10 H-text-align-center H-padding-vertical-top-5 H-font-size-12 color-888">
		目前平台只支持支付宝和微信两种方式充值
		</div>-->
		<div class="H-padding-20">
			<button onclick="openCf();" class="xy_confirm_btn H-position-static H-button H-width-100-percent  H-font-size-15 H-border-none H-padding-vertical-both-12 H-padding-horizontal-both-20  H-theme-font-color-white ">
				确认支付
			</button>
		</div>
		<!--充值策略循环体-->
		<script id="clzl_item" type="text/html">
			{{# for(var i=0,l=d.length;i<l;i++){ }}
			{{# if(i == 0){ }}
			<div class="H-font-size-14 b_czbutton" tapmode onclick="choase(this,{{= d[i].recharge_pay }},{{= d[i].presentation_pay}});">
			<div class="H-border-both H-theme-border-color7 p_active" style="margin: 4px">
			{{# }else{ }}
			<div class="H-font-size-14 b_czbutton" tapmode onclick="choase(this,{{= d[i].recharge_pay }},{{= d[i].presentation_pay}});">
			<div class="H-border-both" style="margin: 4px">
			{{# } }}
			{{ d[i].recharge_pay }}元
			<br />
			<span class="H-theme-font-color-999 H-font-size-10">赠送{{ d[i].presentation_pay }}元</span>
			</div>
			</div>
			{{# } }}
		</script>
		<!--充值策略循环体-->
		<script type="text/javascript" src="../../../script/xy.js"></script>
		<script type="text/javascript" src="../../../script/tools/laytpl.js"></script>
		<script type="text/javascript" src="../../../script/zepto.min.js"></script>
		<script type="text/javascript">
			//支付方式（必填）（1、支付宝，2、微信）
			var pay_way = 1;
			//定向余额活动id（充值余额类型为2时必填）（string）
			var orientact_id = null;
			//订单id
			var orderid = null;
			var itemdata = null;
			var paymoney = null;
			apiready = function() {
				product = api.pageParam.data;
				document.getElementById('dept_name').innerHTML = product.dept_name;
				//alert(A().length);
				//console.log(JSON.stringify(product));
				initPage();
			};
			// 初始化页面
			function initPage() {
				api.getPrefs({
					key : 'userinfo'
				}, function(ret, err) {
					if (ret && ret.value) {
						user = eval('(' + ret.value + ')');
						orientact_id = product.orientact_id;
						//请求选择钱数条目
						moneyItem();
					} else {
						//提示登录
						userlogin();
					}
				});
				//监听返回键
				api.addEventListener({
					name : 'keyback'
				}, function(ret, err) {
					api.closeWin();
				});
			}

			//提示登录
			function userlogin() {
				api.confirm({
					title : '温馨提示',
					msg : '进行该操作前请先登录',
					buttons : ['确定', '取消']
				}, function(ret, err) {
					if (ret.buttonIndex == 1) {
						api.openWin({
							name : 'login_body',
							url : '../../login/login_body.html',
							bounces : false
						});
						setTimeout(function() {
							api.closeWin();
						}, 500);
					} else {
						api.closeWin();
					}
				});
			}

			//请求选择钱数条目
			function moneyItem() {
				$xy.ajax(function(ret, err) {
					//api.hideProgress();
					if (ret.success) {
						//console.log(JSON.stringify(ret));
						console.log(JSON.stringify(ret));
						itemdata = ret.data;
						var tpl = document.getElementById('clzl_item').innerHTML;
						//读取模版
						//方式一：异步渲染（推荐）
						laytpl(tpl).render(itemdata, function(render) {
							api.hideProgress();
							//alert(JSON.stringify(itemdata[0]));
							paymoney = itemdata[0].recharge_pay;
							document.getElementById('recharge_pay').innerHTML = itemdata[0].recharge_pay;
							document.getElementById('presentation_pay').innerHTML = itemdata[0].presentation_pay;
							document.getElementById('clzl_list').innerHTML = render;
						});
					} else {
						//console.log(JSON.stringify(ret));
						var htmls = '<div class="H-position-absolute H-position-center-all" id="statuss"><div class="H-font-size-14 H-text-align-center"><i class="iconfont icon-shebeidingwei H-font-size-32 H-theme-font-color-999"></i><div class="H-theme-font-color-999">暂无金额</div></div></div>';
						document.getElementById('clzl_list').innerHTML = htmls;
					}
				}, 'OrientRule&funid=wash_orient_activity&orientact_id=' + orientact_id);
			}

			//选择钱数的处理
			function choase(obj, money, presentation_pay) {
				paymoney = money;
				presentation_pay = presentation_pay;
				$("#recharge_pay").html(paymoney);
				$("#presentation_pay").html(presentation_pay);
				$(obj).parent().children().children().removeClass("H-theme-border-color7 p_active");
				$(obj).children().addClass("H-theme-border-color7 p_active");
			}

			//选择支付方式
			function check(obj) {
				$(".payway").removeClass('icon-duihao');
				$(obj).find(".payway").addClass('icon-duihao');
				pay_way = $(obj).find(".icon-duihao").attr("payway");
			}

			//支付结果
			function openResult() {
				api.openWin({
					name : 'recharge_success_head',
					url : '../../result/recharge_success_head.html',
					bounces : false,
					delay : 0,
					slidBackEnabled : true,
					vScrollBarEnabled : false,
					hScrollBarEnabled : false
				});
			}

			//支付方法
			function openCf() {
				if (!pay_way) {
					api.toast({
						msg : '请先选择支付方式'
					});
					return;
				};
				//alert(orderid);
				if (pay_way == 1) {
					orderid = "C" + A();
					doPay({
						wash_user_id : user[0].wash_user_id,
						uuid : user[0].uuid,
						recharge_id : orderid, //用户充值记录id
						pay_method : pay_way, //支付方式
						recharge_amount : paymoney, //支付金额
						overage_type : '2', //来源
						orientact_id : product.orientact_id//定向余额Id
					}, function(ret, err) {
						//下单成功返回的数据
						order_no = ret.data;
						if (ret.success) {
							//支付宝支付
							alipayFunction(order_no, orderid);
						} else {
							api.toast({
								msg : '服务器未响应，支付失败'
							});
						}
					});
				} else if (pay_way == 2) {
					orderid = "C" + A();
					//打开支付成功页;
					doPay({
						wash_user_id : user[0].wash_user_id,
						uuid : user[0].uuid,
						recharge_id : orderid, //用户充值记录id
						pay_method : pay_way, //支付方式
						recharge_amount : paymoney, //支付金额
						overage_type : '2', //来源
						orientact_id : product.orientact_id//定向余额Id
					}, function(ret, err) {
						order_no = ret.data;
						if (ret.success) {
							//微信支付
							wxPayFunction(order_no, orderid);
						} else {
							api.toast({
								msg : '抱歉，支付失败'
							});
						}
					});
				}
			}

			//支付宝支付方法
			function alipayFunction(order_no, orderid) {
				var obj = api.require('aliPay');
				obj.config({
					partner : '2088421786244385',
					seller : 'jiyou360@126.com',
					rsaPriKey : 'MIICdgIBADANBgkqhkiG9w0BAQEFAASCAmAwggJcAgEAAoGBAMnRFvabENOHewFvPz4zTLVRG/7hyq8oDcsa+Qw2Wve7bHhSQP/jZPb7gRjiilEKUUtADXqZq1WcllEebVrSapcQrpX3kYlhhdGiSGhGyZRy018UieG3dqvQGXa/3ktqbBKcD3Uqr/1W+5pyNa1g4ABCYWG7/NA8PLMgrjgN/bXZAgMBAAECgYAH6HGF6D2YjE59l+ZagZgX4r2+FwriIieoNb5chCS8YFO3w0FYxYhHRUOhvf69fjIBSNk+XJciG6ioNRED5grXHrJPIfcCIQYOpX0JEb0NhG/jpyOaCHxXKNGjij9qhJFUnmAH6At28N9YX02HZJBZPgx8P1UaOfvlmUxHFrmXIQJBAO73n8/gjFGg0i3lh9tjU/0cb7bdxrgSVovW+nFdMqRGQuNbKbTjjTUQ3PCZ8l5oYUcFI9JaZ/BJyEyhpFsO8ZMCQQDYM5bTV0JxLAJKjH2mmin7KCwSx+bAjQqVhqL/QZ5bsg302fLt4t6NwFknsvz+gWjpPoFR+S4rcCromOZXJs5jAkApxLBzRj1geyqhiRARAbCJejHwlZ0JSXNFKANIU1Dps7o3QRTuICPrVZI4n7/kTnxKTJSxTMoEDvFqq4otvFPvAkBoQliVihrsYICqWp2tXeKoz3KRi/znFhzohojL92Taaz73uLLBrQoN6ZgU4OfIA7gH4rCSS0vMfsbya+mIVZppAkEA5rhmaQ9RCbpcPcd+3jqLpIQtbXrKhsc3YRKtWpH06l2BKG8dDjey9ecLCp/UYWCObSLSvWhNg/1gxaVlAgRUDQ==',
					rsaPubKey : 'MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDJ0Rb2mxDTh3sBbz8+M0y1URv+4cqvKA3LGvkMNlr3u2x4UkD/42T2+4EY4opRClFLQA16matVnJZRHm1a0mqXEK6V95GJYYXRokhoRsmUctNfFInht3ar0Bl2v95LamwSnA91Kq/9VvuacjWtYOAAQmFhu/zQPDyzIK44Df212QIDAQAB',
					notifyURL : window.aliPayurl,
				}, function(ret, err) {
					if (ret.status) {
						obj.pay({
							subject : product.orientact_name,
							body : product.dept_name,
							amount : paymoney,
							tradeNO : orderid
						}, function(ret, err) {
							//1.0 如果支付宝提示付款成功！
							if (ret && ret.statusCode == 9000) {
								openResult(order_no);
							} else {
								deleteOrder(orderid);
							}
						});
					} else {
						deleteOrder(orderid);
					}
				});
			}

			//微信支付方法
			function wxPayFunction(order_no, orderid) {
				var wxPay = api.require('wxPay');
				wxPay.config({
					mchId : '1390880602',
					partnerKey : 'nZ9booT9pQOaIGp5hcrjMs243GPvS7g4',
					notifyUrl : window.wxPayurl
				}, function(ret, err) {
					if (ret.status) {
						//alert('配置商户支付参数成功');
						wxPay.pay({
							description : product.dept_name,
							totalFee : String(parseFloat(paymoney) * 100),
							tradeNo : orderid
						}, function(ret, err) {
							if (ret.status) {
								alert(ret.result);
								//打开支付成功页;
								openResult(order_no);
							} else {
								alert(err.code);
								deleteOrder(orderid);
							}
						});
					} else {
						alert(err.code);
						deleteOrder(orderid);
					}
				});
			}

			//提交支付请求ajax
			function doPay(datas, callback) {
				api.showProgress();
				$xy.Pajax(function(ret, err) {
					api.hideProgress();
					if (ret) {
						//打开支付成功页;
						callback(ret, err);
						//openResult(ret.data);
					} else {
						alert("err====" + err.message);
					}
				}, 'alipayReOrder&funid=wash_user', 'post', {
					values : datas
				});
			}

			//删除订单方法
			function deleteOrder(orderid) {
				$xy.ajax(function(ret, err) {
					if (ret.success) {
						api.toast({
							msg : '支付失败，订单取消'
						});
						setTimeout(function() {
							api.closeWin();
						}, 800);
					} else {
						api.toast({
							msg : ret.message
						});
					}
				}, 'deleteOrder&funid=wash_order&wash_user_id=' + user[0].wash_user_id + '&uuid=' + user[0].uuid + '&order_id=' + orderid);
			}

			//生成随机订单号
			function A() {
				var date = new Date();
				var seperator1 = "-";
				var year = date.getFullYear();
				var month = date.getMonth() + 1;
				var strDate = date.getDate();
				var hour = date.getHours();
				var minutes = date.getMinutes();
				var seconds = date.getSeconds();
				if (month >= 1 && month <= 9) {
					month = "0" + month;
				}
				if (strDate >= 0 && strDate <= 9) {
					strDate = "0" + strDate;
				}
				if (hour >= 0 && hour <= 9) {
					hour = "0" + hour;
				}
				if (minutes >= 0 && minutes <= 9) {
					minutes = "0" + minutes;
				}
				if (seconds >= 0 && seconds <= 9) {
					seconds = "0" + seconds;
				}
				var currentdate = String(year) + String(month) + String(strDate) + String(hour) + String(minutes) + String(seconds) + String(MathRand());
				return currentdate;
			}

			function MathRand() {
				var Num = "";
				for (var i = 0; i < 4; i++) {
					Num += Math.floor(Math.random() * 10);
				}
				return Num;
			}
		</script>
	</body>
</html>