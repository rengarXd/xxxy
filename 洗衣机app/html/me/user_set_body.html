<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,initial-scale=1.0,width=device-width" />
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>body</title>
		<link rel="stylesheet" href="../../css/style.css" />
		<link rel="stylesheet" type="text/css" href="../../css/Hui.css" />
		<style>
			.pic {
				width: 50px;
				height: 50px;
				border-radius: 50%
			}
		</style>
	</head>

	<body>
		<div id="dengdai" class="H-position-absolute H-position-center-all" id="statuss">
			<div class="H-font-size-14 H-text-align-center">
				<i class="iconfont icon-webiconxiyiji H-font-size-32 H-theme-font-color-999"></i>
				<div class="H-theme-font-color-999" id="jiazai">
					加载中...
				</div>
			</div>
		</div>
		<div id="xiangqing" style="display:none;">
			<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-vertical-middle" tapmode="H-touch-active" onclick="setvatar();">
				<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-16 H-padding-vertical-both-12">
					头像
				</div>
				<span class="H-badge H-display-block"><img src="../../image/noavatar.gif" id="nopic" class="pic H-margin-vertical-top-5" style="line-height: 20px;"/></span>
				<span class="H-icon H-padding-horizontal-right-5 H-display-block"><i class="H-iconfont H-icon-arrow-right H-theme-font-color-ccc H-font-size-14 H-vertical-middle"></i></span>
			</div>
			<div class="H-padding-vertical-bottom-10"></div>
			<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle ">
				<div class="H-flex-item  H-padding-horizontal-both-10 H-font-size-16 H-padding-vertical-both-12">
					账号
				</div>
				<span class="H-padding-horizontal-right-25" id="phone_number">未登录</span>
			</div>
			<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle H-touch-active" tapmode="H-touch-active" onclick="openPwd();">
				<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-16 H-padding-vertical-both-12">
					密码
				</div>
				<span class="H-icon H-padding-horizontal-right-5 H-display-block"><i class="H-iconfont H-icon-arrow-right H-theme-font-color-ccc H-font-size-14 H-vertical-middle"></i></span>
			</div>
			<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle H-touch-active" id="pet_name" tapmode="H-touch-active" onclick="Change(pet_name);">
				<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-16 H-padding-vertical-both-12">
					昵称
				</div>
				<span class="H-badge H-display-block H-margin-horizontal-right-5" id="nicknamename">昵称</span>
				<span class="H-icon H-padding-horizontal-right-5 H-display-block"><i class="H-iconfont H-icon-arrow-right H-theme-font-color-ccc H-font-size-14 H-vertical-middle"></i></span>
			</div>
			<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle H-touch-active" id="locality_university" tapmode="H-touch-active" onclick="Change(locality_university);">
				<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-16 H-padding-vertical-both-12">
					学校
				</div>
				<span class="H-badge H-display-block H-margin-horizontal-right-5" id="schoolname"></span>
				<span class="H-icon H-padding-horizontal-right-5 H-display-block"><i class="H-iconfont H-icon-arrow-right H-theme-font-color-ccc H-font-size-14 H-vertical-middle"></i></span>
			</div>
			<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-vertical-middle H-touch-active" id="grade" tapmode="H-touch-active" onclick="openPick();">
				<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-16 H-padding-vertical-both-12">
					年级
				</div>
				<span class="H-badge H-display-block H-margin-horizontal-right-5" id="gradename"></span>
				<span class="H-icon H-padding-horizontal-right-5 H-display-block"><i class="H-iconfont H-icon-arrow-right H-theme-font-color-ccc H-font-size-14 H-vertical-middle"></i></span>
			</div>
			<div class="H-padding-vertical-bottom-10"></div>
			<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle H-touch-active">
				<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-16 H-padding-vertical-both-12">
					换绑手机
				</div><span class="H-icon H-padding-horizontal-right-5 H-display-block"><i class="H-iconfont H-icon-arrow-right H-theme-font-color-ccc H-font-size-14 H-vertical-middle"></i></span>
			</div>
			<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-vertical-middle H-touch-active" id="dormitory_building" tapmode="H-touch-active" onclick="Change(dormitory_building);">
				<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-16 H-padding-vertical-both-12">
					宿舍楼栋
				</div>
				<span class="H-badge H-display-block H-margin-horizontal-right-5" id="dormitory_buildingname"></span>
				<span class="H-icon H-padding-horizontal-right-5 H-display-block"><i class="H-iconfont H-icon-arrow-right H-theme-font-color-ccc H-font-size-14 H-vertical-middle"></i></span>
			</div>
			<footer class="H-footer H-padding-15 ">
				<button tapmode="H-touch-active" onclick="exit();" class="xy_login_btn H-margin-vertical-top-10 H-position-static H-button H-width-100-percent  H-font-size-15 H-border-none H-padding-vertical-both-12 H-padding-horizontal-both-20  H-theme-font-color-white ">
				退出登录
			</button>
			</footer>
		</div>
		<script type="text/javascript" src="../../script/xy.js"></script>
		<script type="text/javascript" src="../../script/zepto.min.js"></script>
		<script type="text/javascript" src="../../script/uploadimg/upImg.js"></script>
		<script type="text/javascript">
			var HeadPortrait = null,
				NickName = null,
				SchoolName = null,
				Grade = null,
				DormRoom = null;
			var id = null;
			var textname = null;

			apiready = function() {
				initPage();
			};
			Zepto(function($) {});
			// 初始化页面
			function initPage() {
				//				api.getPrefs({
				//					key: 'userinfo'
				//				}, function(ret, err) {
				//					//alert(JSON.stringify(user));
				//					if(ret && ret.value) {
				//						console.log(JSON.stringify(user.phone_number));
				//						var user = eval('(' + ret.value + ')');
				//						$("#userTel").html(user[0].phone_number);
				//					}
				//				});
				//初始化页面获取个人信息
				api.getPrefs({
					key: 'userinfo'
				}, function(ret, err) {
					if(ret && ret.value) {
						user = eval('(' + ret.value + ')');
						wash_user_id = user[0].wash_user_id;
						uuid = user[0].uuid;
						$xy.ajax(function(ret, err) {
							//api.hideProgress();
							if(ret) {
								console.log(JSON.stringify(ret));
								//$("#nonetwork").hide();
								api.refreshHeaderLoadDone();
								if(ret.success) {
									//console.log(JSON.stringify(ret));
									document.getElementById('phone_number').innerHTML = ret.data[0].phone_number;
									document.getElementById('nicknamename').innerHTML = ret.data[0].pet_name;
									document.getElementById('schoolname').innerHTML = ret.data[0].locality_university;
									document.getElementById('dormitory_buildingname').innerHTML = ret.data[0].dormitory_building;
									document.getElementById('gradename').innerHTML = ret.data[0].grade;
									//document.getElementById('dormitory_buildingname').innerHTML = textname;
									$("#dengdai").css("display", "none");
									$("#xiangqing").css("display", "block");

								} else {
									//console.log(JSON.stringify(ret));

									api.toast({
										msg: '很抱歉，网络异常！'
									});
								}
							} else {
								console.log(JSON.stringify("false"));
							}
						}, 'appUserInfo&funid=wash_user&wash_user_id=' + wash_user_id + '&uuid=' + uuid);
					} else {
						$("#jiazai").html("暂无订单");
					}
				});

			}

			function openPwd() {
				api.openWin({
					name: 'pwd_set_head',
					url: './setting/pwd_set_head.html',
					bounces: false,
					delay: 0,
					slidBackEnabled: true,
					vScrollBarEnabled: false,
					hScrollBarEnabled: false
				});
			}
			//修改年级
			function openPick() {
				var id = "grade";
				var grade = grade;
				var date = new Date();
				var year = date.getFullYear();
				api.actionSheet({
					title: '年级',
					cancelTitle: '取消',
					buttons: [year - 4 + '级', year - 3 + '级', year - 2 + '级', year - 1 + '级', year + '级']
				}, function(ret, err) {
					var index = ret.buttonIndex;
					//console.log(index);
					//alert(year - 5 + index + '级');
					textname = year - 5 + index + '级';
					document.getElementById('gradename').innerHTML = textname;

					ajax(id, textname);
					//ajax(id, textname);
					//					switch(index) {
					//						case 1:
					//							alert(year - 4 + '级');
					//							textname=year - 4 + '级'
					//							ajax(id, textname);
					//							
					//							break;
					//						case 2:
					//							alert(year - 3 + '级');
					//							break;
					//							case 3:
					//							alert(year - 2 + '级');
					//							break;
					//							case 4:
					//							alert(year - 1 + '级');
					//							break;
					//							case 5:
					//							alert(year  + '级');
					//							break;
					//					}

				});
			}

			function setvatar() {
				api.actionSheet({
					title: '请选择您要上传头像的方式',
					cancelTitle: '取消',
					buttons: ['拍照', '相册']
				}, function(ret, err) {
					if(ret) {
						switch(ret.buttonIndex) {
							case 1:
								//拍照处理
								api.getPicture({
									sourceType: 'camera',
									encodingType: 'jpg',
									mediaValue: 'pic',
									destinationType: 'url',
									allowEdit: true,
									quality: 50,
									targetWidth: 300,
									targetHeight: 200,
									saveToPhotoAlbum: false
								}, function(ret, err) {
									if(ret) {
										var returnUrl = ret.data;
										console.log(returnUrl);
										$("#nopic").attr("src", returnUrl);
									} else {
										api.toast({
											msg: JSON.stringify(err)
										});
									}
								});
								break;
							case 2:
								api.getPicture({
									sourceType: 'library',
									encodingType: 'jpg',
									mediaValue: 'pic',
									destinationType: 'url',
									allowEdit: true,
									quality: 50,
									targetWidth: 100,
									targetHeight: 100,
									saveToPhotoAlbum: false
								}, function(ret, err) {
									if(ret) {
										var returnUrl = ret.data;

										$("#nopic").attr("src", returnUrl);
									} else {
										api.toast({
											msg: JSON.stringify(err)
										});
									}
								});
								break;
						};
					} else {
						api.toast({
							msg: ''
						});
					}
				});
			}

			//修改昵称ChangeNickname
			function Change(id) {
				var id = id;
				var dialogBox = api.require('dialogBox');
				dialogBox.input({
					keyboardType: 'default',
					texts: {
						title: '请输入想要修改的信息',
						placeholder: '',
						leftBtnTitle: '取消',
						rightBtnTitle: '确定'
					},
					styles: {
						bg: '#fff',
						w: 300,
						h: 150,
						title: {
							h: 20,
							alignment: 'center',
							size: 14,
							color: '#000',
							marginT: 40
								//marginT: 10
						},
						input: {
							h: 20,
							marginUD: 3,
							textSize: 14,
							textColor: '#000'
						},
						dividingLine: {
							width: 0.5,
							color: '#696969'
						},
						left : {
						marginB : 0,
						marginL : 0,
						w : 150,
						h : 200,
						bg : '#fff',
						color : '#cacaca',
						size : 15
					},
					right : {
						marginB : 0,
						marginL : 0,
						w : 150,
						h : 200,
						bg : '#119ed1',
						color : '#fff',
						size : 15
					}
					}
				}, function(ret) {
					if(ret.eventType == 'right') {
						var textname = ret.text

						//昵称
						if(id == pet_name) {
							id = "pet_name";
							ajax(id, textname);
							document.getElementById('nicknamename').innerHTML = textname;
						}
						//学校
						if(id == locality_university) {
							id = "locality_university";
							ajax(id, textname);
							document.getElementById('schoolname').innerHTML = textname;
						}
						//宿舍楼栋
						if(id == dormitory_building) {
							id = "dormitory_building";
							ajax(id, textname);
							document.getElementById('dormitory_buildingname').innerHTML = textname;
						}

						//关闭弹出框
						dialogBox.close({
							dialogName: 'input'
						});
					}
					if(ret.eventType == 'left') {
						//var dialogBox = api.require('dialogBox');
						dialogBox.close({
							dialogName: 'input'
						});
					}
				});
			}
			//修改昵称提交服务器
			function ajax(id, textname) {
				var id = id;
				var textname = textname;
				api.getPrefs({
					key: 'userinfo'
				}, function(ret, err) {
					if(ret && ret.value) {
						user = eval('(' + ret.value + ')');
						wash_user_id = user[0].wash_user_id;
						uuid = user[0].uuid;
						console.log(id);
						console.log(textname);
						$xy.ajax(function(ret, err) {
							//api.hideProgress();
							if(ret) {
								console.log(JSON.stringify(ret));
								//$("#nonetwork").hide();
								api.refreshHeaderLoadDone();
								if(ret.success) {
									//console.log(JSON.stringify(ret));
//									api.alert({
//										msg: JSON.stringify(ret)
//
//									});

								} else {
									//console.log(JSON.stringify(ret));
									$("#jiazai").html("暂无订单");
									api.toast({
										msg: '很抱歉，您可能没有订单！'
									});
								}
							} else {
								console.log(JSON.stringify("false"));
								//					api.refreshHeaderLoadDone();
								//					$("#nonetwork").show();
							}
						}, 'editUserinfo&funid=wash_user&wash_user_id=' + wash_user_id + '&uuid=' + uuid + '&' + id + '=' + textname);
					} else {
						$("#jiazai").html("暂无订单");
					}
				});
			}

			//退出登录
			function exit() {
				api.confirm({
					title: '温馨提示',
					msg: '您确定要退出登录吗？',
					buttons: ['取消', '确定']
				}, function(ret, err) {
					if(ret.buttonIndex == 2) {
						api.removePrefs({
							key: 'userinfo'
						});
						api.execScript({
							name: 'main',
							frameName: 'me_index',
							script: 'reload();'
						});
						//延时关闭窗口
						setTimeout(function() {
							api.closeWin();
						}, 500);
					}
				});
			}
		</script>
	</body>

</html>