<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>用户信息设置body</title>
		<link rel="stylesheet" href="../../css/style.css" />
		<link rel="stylesheet" type="text/css" href="../../css/Hui.css" />
		<style>
			.pic {
				width: 50px;
				height: 50px;
				border-radius: 50%
			}
		</style>
	</head>
	<body>
		<div id="dengdai" class="H-position-absolute H-position-center-all" id="statuss">
			<div class="H-font-size-14 H-text-align-center">
				<i class="iconfont icon-webiconxiyiji H-font-size-32 H-theme-font-color-999"></i>
				<div class="H-theme-font-color-999" id="jiazai">
					加载中...
				</div>
			</div>
		</div>
		<div id="xiangqing" style="display:none;">
			<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-vertical-middle" tapmode="H-touch-active" onclick="setvatar();">
				<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-16 H-padding-vertical-both-12">
					头像
				</div>
				<span class="H-badge H-display-block"><img onerror="javascript:this.src='../../image/noavatar.gif'" src="../../image/noavatar.gif" id="nopic" class="pic H-margin-vertical-top-5" style="line-height: 20px;"/></span>
				<span class="H-icon H-padding-horizontal-right-5 H-display-block"><i class="H-iconfont H-icon-arrow-right H-theme-font-color-ccc H-font-size-14 H-vertical-middle"></i></span>
			</div>
			<div class="H-padding-vertical-bottom-10"></div>
			<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle ">
				<div class="H-flex-item  H-padding-horizontal-both-10 H-font-size-16 H-padding-vertical-both-12">
					账号
				</div>
				<span class="H-padding-horizontal-right-25" id="phone_number">未登录</span>
			</div>
			<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle H-touch-active" id="pet_name" tapmode="H-touch-active" onclick="changeInfo('昵称','pet_name');">
				<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-16 H-padding-vertical-both-12">
					昵称
				</div>
				<span class="H-badge H-display-block H-margin-horizontal-right-5" id="nicknamename">昵称</span>
				<span class="H-icon H-padding-horizontal-right-5 H-display-block"><i class="H-iconfont H-icon-arrow-right H-theme-font-color-ccc H-font-size-14 H-vertical-middle"></i></span>
			</div>
			<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle H-touch-active" id="locality_university" tapmode="H-touch-active" onclick="changeInfo('学校','locality_university');">
				<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-16 H-padding-vertical-both-12">
					学校
				</div>
				<span class="H-badge H-display-block H-margin-horizontal-right-5" id="schoolname"></span>
				<span class="H-icon H-padding-horizontal-right-5 H-display-block"><i class="H-iconfont H-icon-arrow-right H-theme-font-color-ccc H-font-size-14 H-vertical-middle"></i></span>
			</div>
			<div class="H-border-vertical-bottom-after H-text-list H-flexbox-horizontal  H-theme-background-color-white H-vertical-middle H-touch-active" id="grade" tapmode="H-touch-active" onclick="openPick();">
				<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-16 H-padding-vertical-both-12">
					年级
				</div>
				<span class="H-badge H-display-block H-margin-horizontal-right-5" id="gradename"></span>
				<span class="H-icon H-padding-horizontal-right-5 H-display-block"><i class="H-iconfont H-icon-arrow-right H-theme-font-color-ccc H-font-size-14 H-vertical-middle"></i></span>
			</div>
			<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-vertical-middle H-touch-active" id="dormitory_building" tapmode="H-touch-active" onclick="changeInfo('宿舍楼栋','dormitory_building');">
				<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-16 H-padding-vertical-both-12">
					宿舍楼栋
				</div>
				<span class="H-badge H-display-block H-margin-horizontal-right-5" id="dormitory_buildingname"></span>
				<span class="H-icon H-padding-horizontal-right-5 H-display-block"><i class="H-iconfont H-icon-arrow-right H-theme-font-color-ccc H-font-size-14 H-vertical-middle"></i></span>
			</div>
			<div class="H-padding-vertical-bottom-10"></div>
			<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle H-touch-active" tapmode="H-touch-active" onclick="ChangePhoneNumber();">
				<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-16 H-padding-vertical-both-12">
					换绑手机
				</div><span class="H-icon H-padding-horizontal-right-5 H-display-block"><i class="H-iconfont H-icon-arrow-right H-theme-font-color-ccc H-font-size-14 H-vertical-middle"></i></span>
			</div>
			<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white  H-vertical-middle H-touch-active" tapmode="H-touch-active" onclick="openPwd();">
				<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-16 H-padding-vertical-both-12">
					密码
				</div>
				<span class="H-icon H-padding-horizontal-right-5 H-display-block"><i class="H-iconfont H-icon-arrow-right H-theme-font-color-ccc H-font-size-14 H-vertical-middle"></i></span>
			</div>
			<footer class="H-footer H-padding-15 ">
				<button tapmode="H-touch-active" onclick="exit();" class="xy_login_btn H-margin-vertical-top-10 H-position-static H-button H-width-100-percent  H-font-size-15 H-border-none H-padding-vertical-both-12 H-padding-horizontal-both-20  H-theme-font-color-white ">
					退出登录
				</button>
			</footer>
		</div>
		<script type="text/javascript" src="../../script/xy.js"></script>
		<script type="text/javascript" src="../../script/zepto.min.js"></script>
		<script type="text/javascript" src="../../script/uploadimg/upImg.js"></script>
		<script type="text/javascript">
			var HeadPortrait = null, NickName = null, SchoolName = null, Grade = null, DormRoom = null;
			var id = null;
			var textname = null;
			var wash_user_id = null;
			var uuid = null;
			var attach_name = null;
			apiready = function() {
				// 引入过滤压缩模块
				imageFilter = api.require("imageFilter");
				initPage();
			};
			Zepto(function($) {
			});
			function reload() {
				location.reload();
			}

			// 初始化页面
			function initPage() {
				//初始化页面获取个人信息
				api.getPrefs({
					key : 'userinfo'
				}, function(ret, err) {
					if (ret && ret.value) {
						user = eval('(' + ret.value + ')');
						wash_user_id = user[0].wash_user_id;
						uuid = user[0].uuid;
						$xy.ajax(function(ret, err) {
							//api.hideProgress();
							if (ret) {
								console.log(JSON.stringify(ret));
								//$("#nonetwork").hide();
								api.refreshHeaderLoadDone();
								if (ret.success) {
									//console.log(JSON.stringify(ret));
									document.getElementById('phone_number').innerHTML = ret.data[0].phone_number;
									document.getElementById('nicknamename').innerHTML = ret.data[0].pet_name;
									document.getElementById('schoolname').innerHTML = ret.data[0].locality_university;
									document.getElementById('dormitory_buildingname').innerHTML = ret.data[0].dormitory_building;
									document.getElementById('gradename').innerHTML = ret.data[0].grade;
									//渲染头像
									if (ret.data[0].attach_path != "") {
										$("#nopic").attr('src', window.washUrl + ret.data[0].attach_path);
									}
									//document.getElementById('dormitory_buildingname').innerHTML = textname;
									//等待CSS隐藏
									$("#dengdai").css("display", "none");
									//等待详情CSS隐藏
									$("#xiangqing").css("display", "block");
								} else {
									//console.log(JSON.stringify(ret));
									api.toast({
										msg : '很抱歉，网络异常！'
									});
								}
							} else {
								api.toast({
									msg : '很抱歉，网络异常！'
								});
							}
						}, 'appUserInfo&funid=wash_user&wash_user_id=' + wash_user_id + '&uuid=' + uuid);
					} else {
						//无订单情况处理
						$("#jiazai").html("暂无用户信息");
					}
				});
			}

			//打开修改密码
			function openPwd() {
				var sys = api.systemType;
				//安卓加载延迟设置
				sys != "ios" ? delay = 100 : delay = 0;
				api.openWin({
					name : 'pwd_set_head',
					url : './setting/pwd_set_head.html',
					bounces : false,
					delay : delay,
					slidBackEnabled : true,
					vScrollBarEnabled : false,
					hScrollBarEnabled : false,
					animation : {
						type : "reveal", //动画类型（详见动画类型常量）
						subType : "from_right", //动画子类型（详见动画子类型常量）
						duration : 0 //动画过渡时间，默认300毫秒
					}
				});
			}

			//修改年级
			function openPick() {
				var id = "grade";
				var grade = grade;
				var date = new Date();
				var year = date.getFullYear();
				api.actionSheet({
					title : '年级',
					cancelTitle : '取消',
					buttons : [year - 4 + '级', year - 3 + '级', year - 2 + '级', year - 1 + '级', year + '级']
				}, function(ret, err) {
					var index = ret.buttonIndex;
					if (index <= 5) {
						console.log(index);
						//alert(year - 5 + index + '级');
						textname = year - 5 + index + '级';
						document.getElementById('gradename').innerHTML = textname;
						ajax(id, textname);
					}
				});
			}

			// 图片压缩
			// imgsrc：源图片的路径
			// quality：图片压缩质量，一般建议0.5
			// scale：图片压缩比例，也是建议0.5
			// ext：源图片拓展名
			// callback：转换成功之后回调函数
			function imgCompress(imgsrc, quality, scale, ext, callback) {
				// 压缩文件的保存目录
				var savePath = api.cacheDir + '/picture/' + getNowFormatDate() + '/';
				// 压缩文件生成的随机文件名称
				var savename = NewGuid() + "." + ext;
				imageFilter.compress({
					img : imgsrc,
					quality : quality,
					scale : quality,
					save : {
						album : false,
						imgPath : savePath,
						imgName : savename
					}
				}, function(ret, err) {
					if (ret) {
						callback(savePath + savename);
					} else {
						api.toast({
							msg : JSON.stringify(err)
						});
					}
				});
			}

			//生成随机文件名
			function NewGuid() {
				function S4() {
					return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
				}

				return (S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4());
			}

			//获取当前时间
			function getNowFormatDate() {
				var date = new Date();
				var seperator1 = "-";
				var year = date.getFullYear();
				var month = date.getMonth() + 1;
				var strDate = date.getDate();
				if (month >= 1 && month <= 9) {
					month = "0" + month;
				}
				if (strDate >= 0 && strDate <= 9) {
					strDate = "0" + strDate;
				}
				var currentdate = year + seperator1 + month + seperator1 + strDate
				return currentdate;
			}

			// 获取文件拓展名
			function getExt(fileName) {
				return fileName.substring(fileName.lastIndexOf('.') + 1);
			}

			//打开设置头像
			function setvatar() {
				api.actionSheet({
					title : '请选择您要上传头像的方式',
					cancelTitle : '取消',
					buttons : ['拍照', '相册']
				}, function(ret, err) {
					if (ret) {
						switch(ret.buttonIndex) {
							case 1:
								//拍照处理
								api.getPicture({
									sourceType : 'camera',
									encodingType : 'jpg',
									mediaValue : 'pic',
									destinationType : 'url',
									allowEdit : true,
									quality : 50,
									saveToPhotoAlbum : false
								}, function(ret, err) {
									if (ret) {
										var returnUrl = ret.data;
										console.log(returnUrl);
										//$("#nopic").attr("src", returnUrl);
										//压缩图片
										imgCompress(returnUrl, 0.5, 0.5, getExt(returnUrl), function(compressImg) {
											$("#nopic").attr("src", compressImg);
											//console.log(JSON.stringify(compressImg));
											attach_name = compressImg;
											//console.log(JSON.stringify(attach_name));
											//提交头像到服务器
											Get_HeadPortrait_ID(attach_name);
										});
									} else {
										api.toast({
											msg : JSON.stringify(err)
										});
									}
								});
								break;
							case 2:
								api.getPicture({
									sourceType : 'library',
									encodingType : 'jpg',
									mediaValue : 'pic',
									destinationType : 'url',
									allowEdit : true,
									quality : 50,
									saveToPhotoAlbum : false
								}, function(ret, err) {
									if (ret) {
										var returnUrl = ret.data;
										//$("#nopic").attr("src", returnUrl);
										//压缩图片
										imgCompress(returnUrl, 0.5, 0.5, getExt(returnUrl), function(compressImg) {
											$("#nopic").attr("src", compressImg);
											//console.log(JSON.stringify(compressImg));
											attach_name = compressImg;
											//console.log(attach_name);
											Get_HeadPortrait_ID(attach_name);
										});
									} else {
										api.toast({
											msg : JSON.stringify(err)
										});
									}
								});
								break;
						};
					} else {
						api.toast({
							msg : ''
						});
					}
				});
			}

			//更改信息方法
			function changeInfo(name, info) {
				api.openFrame({
					name : 'userinfo_change_frame',
					url : 'userinfo_change_frame.html',
					bounces : false,
					pageParam : {
						name : name,
						info : info
					},
					vScrollBarEnabled : false,
					hScrollBarEnabled : false
				});
			}

			//修改昵称ChangeNickname
			function Change(id) {
				var id = id;
				var dialogBox = api.require('dialogBox');
				dialogBox.input({
					keyboardType : 'default',
					texts : {
						title : '请输入想要修改的信息',
						placeholder : '',
						leftBtnTitle : '取消',
						rightBtnTitle : '确定'
					},
					styles : {
						bg : '#fff',
						w : 300,
						h : 150,
						title : {
							h : 20,
							alignment : 'center',
							size : 14,
							color : '#000',
							marginT : 40
							//marginT: 10
						},
						input : {
							h : 20,
							marginUD : 3,
							textSize : 14,
							textColor : '#000'
						},
						dividingLine : {
							width : 0.5,
							color : '#696969'
						},
						left : {
							marginB : 0,
							marginL : 0,
							w : 150,
							h : 'auto',
							bg : '#fff',
							color : '#cacaca',
							size : 15
						},
						right : {
							marginB : 0,
							marginL : 0,
							w : 150,
							h : 'auto',
							bg : '#119ed1',
							color : '#fff',
							size : 15
						}
					}
				}, function(ret) {
					if (ret.eventType == 'right') {
						var textname = ret.text
						//昵称
						if (id == pet_name) {
							id = "pet_name";
							ajax(id, textname);
							document.getElementById('nicknamename').innerHTML = textname;
						}
						//学校
						if (id == locality_university) {
							id = "locality_university";
							ajax(id, textname);
							document.getElementById('schoolname').innerHTML = textname;
						}
						//宿舍楼栋
						if (id == dormitory_building) {
							id = "dormitory_building";
							ajax(id, textname);
							document.getElementById('dormitory_buildingname').innerHTML = textname;
						}
						//关闭弹出框
						dialogBox.close({
							dialogName : 'input'
						});
					}
					if (ret.eventType == 'left') {
						//var dialogBox = api.require('dialogBox');
						dialogBox.close({
							dialogName : 'input'
						});
					}
				});
			}

			//修改昵称提交服务器
			function ajax(id, textname) {
				var id = id;
				var textname = textname;
				api.getPrefs({
					key : 'userinfo'
				}, function(ret, err) {
					if (ret && ret.value) {
						user = eval('(' + ret.value + ')');
						wash_user_id = user[0].wash_user_id;
						uuid = user[0].uuid;
						//console.log(id);
						//console.log(textname);
						$xy.ajax(function(ret, err) {
							//api.hideProgress();
							if (ret) {
								console.log(JSON.stringify(ret));
								//$("#nonetwork").hide();
								api.refreshHeaderLoadDone();
								if (ret.success) {
									//console.log(JSON.stringify(ret));
									//									api.alert({
									//										msg: JSON.stringify(ret)
									//
									//									});
								} else {
									//console.log(JSON.stringify(ret));
									$("#jiazai").html("获取用户信息失败");
									api.toast({
										msg : '很抱歉，获取用户信息失败！'
									});
								}
							} else {
								console.log(JSON.stringify("false"));
								//					api.refreshHeaderLoadDone();
								//					$("#nonetwork").show();
							}
						}, 'editUserinfo&funid=wash_user&wash_user_id=' + wash_user_id + '&uuid=' + uuid + '&' + id + '=' + textname);
					} else {
						$("#jiazai").html("获取用户信息失败");
					}
				});
			}

			//退出登录
			function exit() {
				api.confirm({
					title : '温馨提示',
					msg : '您确定要退出登录吗？',
					buttons : ['取消', '确定']
				}, function(ret, err) {
					if (ret.buttonIndex == 2) {
						var ajpush = api.require('ajpush');
						ajpush.stopPush(function(ret) {
							if (ret && ret.status) {
								//success
							} else {
								//								api.toast({
								//									msg : '退出失败'
								//								});
							}
						});
						api.removePrefs({
							key : 'userinfo'
						});
//						api.removePrefs({
//	                        key:'washtime'
//                      });
						api.sendEvent({
							name : 'reload'
						});
						//延时关闭窗口
						setTimeout(function() {
							api.closeWin();
						}, 500);
					}
				});
			}

			//换绑手机
			function ChangePhoneNumber() {
				var sys = api.systemType;
				//安卓加载延迟设置
				sys != "ios" ? delay = 100 : delay = 0;
				api.openWin({
					name : 'change_phone_1_head',
					url : './setting/change_phone_1_head.html',
					bounces : false,
					delay : delay,
					slidBackEnabled : true,
					vScrollBarEnabled : false,
					animation : {
						type : "reveal", //动画类型（详见动画类型常量）
						subType : "from_right", //动画子类型（详见动画子类型常量）
						duration : 0 //动画过渡时间，默认300毫秒
					}
				});
			}

			//上传头像方法
			function Get_HeadPortrait_ID(attach_name) {
				api.showProgress({
					title : '上传中'
				});
				$xy.imgAjax(function(ret, err) {
					if (ret) {
						//console.log(JSON.stringify(ret));
						//$("#nonetwork").hide();
						if (ret.success) {
							var attachid = ret.data.attachId;
							$xy.ajax(function(ret, err) {
								//执行main页面获取用户信息的函数
								api.execScript({
									name : 'main',
									script : 'initInfo();'
								});
								api.hideProgress();
								api.toast({
									msg : '上传成功！'
								});
							}, 'upUserAttach&funid=wash_user' + '&attachId=' + attachid + '&dataid=' + wash_user_id);
							//console.log(JSON.stringify(ret));
						} else {
							api.hideProgress();
							api.toast({
								msg : ret.message
							});
						}
					} else {
						api.hideProgress();
						api.toast({
							msg : '连接失败，请检查网络配置'
						});
					}
				}, 'post', {
					values : {
						funid : "sys_attach",
						pagetype : "editgrid",
						eventcode : "create",
						nousercheck : "1",
						dataType : "byte",
						datafunid : "wash_user",
						dataid : wash_user_id,
						attach_name : attach_name
					},
					files : {
						attach_path : attach_name
					}
				});
			}
		</script>
	</body>
</html>