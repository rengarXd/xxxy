<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>导航栏</title>
		<link rel="stylesheet" type="text/css" href="../css/Hui.css"/>
		<link rel="stylesheet" type="text/css" href="../css/fonts/iconfont.css"/>
		<link rel="stylesheet" href="../css/style.css" />
		<style>
			.active {
				color: #fff !important;
				background-color: #21aaf2 !important;
				border-width: 0 !important;
			}
			.H_footer_active {
				background: #ffffff;
				/*color: #555555;*/
			}
			.switch-item {
				color: #555555;
			}
			.brige {
				display: inline-block;
				position: absolute;
				top: 10px;
				left: 28%;
				z-index: 100;
				background: red;
				border-radius: 50%;
				-webkit-border-radius: 50%;
				font-size: 9px;
				height: 8px;
				line-height: 12px;
				text-align: center;
				min-width: 8px;
				color: #fff;
				font-style: normal;
			}
			.toast_top {
				background-color: #ffffcc;
				color: #ff6600;
			}
		</style>
	</head>
	<body class="H-flexbox-vertical">
		<header class="H-header b_header_bg" id="index_header">
			<span tapmode="H-theme-font-color-444" onclick="openWin('msg_head','message/msg_head.html');" class="H-font-size-18 H-icon H-position-relative H-display-inline-block H-float-right H-vertical-middle H-theme-font-color-white H-padding-horizontal-right-20 H-z-index-100"><i class="iconfont icon-36 H-font-size-20" ></i><em class="brige"></em></span>
			<div class="H-header-title H-center-all H-font-size-18 H-text-show-row-1 H-theme-font-color-white H-position-absolute H-width-100-percent">
				咭咭洗衣
			</div>
		</header>
		<header class="H-header H-header-title b_header_bg H-display-none" id="massages_header">
			<span tapmode="H-theme-font-color-444" onclick="openWin('msg_head','message/msg_head.html');" class="H-font-size-18 H-icon H-position-relative H-display-inline-block H-float-right H-vertical-middle H-theme-font-color-white H-padding-horizontal-right-20 H-z-index-100"><i class="iconfont icon-36 H-font-size-20" ></i><em class="brige"></em></span>
			<div class="H-header-title H-center-all H-font-size-18 H-text-show-row-1 H-theme-font-color-white H-position-absolute H-width-100-percent">
				订单
			</div>
		</header>
		<header class="H-header H-header-title me_header_bg H-display-none" id="setting_header">
			<span tapmode="H-theme-font-color-444" onclick="openWin('msg_head','message/msg_head.html');" class="H-font-size-18 H-icon H-position-relative H-display-inline-block H-float-right H-vertical-middle H-theme-font-color-white H-padding-horizontal-right-20 H-z-index-100"><i class="iconfont icon-36 H-font-size-20" ></i><em class="brige"></em></span>
		</header>
		<!--	<header class="H-header b_header_bg" id="index_header">
		<span tapmode="H-theme-font-color-444" onclick="openWin('msg_head','message/msg_head.html');" class="H-font-size-18 H-icon H-position-relative H-display-inline-block H-float-right H-vertical-middle H-theme-font-color-white H-padding-horizontal-right-15 H-z-index-100"><i class="iconfont icon-36 H-font-size-20" ></i><em class="brige"></em></span>
		<div class="H-header-title H-center-all H-font-size-18 H-text-show-row-1 H-theme-font-color-white H-position-absolute H-width-100-percent">
		小宛洗衣
		</div>
		<div class="H-header-title H-center-all H-font-size-18 H-text-show-row-1 H-theme-font-color-white H-position-absolute H-width-100-percent" style="display: none">
		订单
		</div>
		<div class="H-header-title H-center-all H-font-size-18 H-text-show-row-1 H-theme-font-color-white H-position-absolute H-width-100-percent" style="display: none">
		我的
		</div>
		</header>-->
		<footer id="index_footer" style="bottom: 0" class="H-footer H-position-fixed H-flexbox-horizontal H-theme-background-color-white">
			<div class="H-flex-item  H-center-all H-padding-vertical-both-10 H-theme-border-color-white switch-item active" style="border-width: 0 0 2px  0">
				<div class="">
					<span class="H-icon H-display-block H-line-height-normal" style="margin-left: 1px;"><i class="iconfont icon-shouye-copy H-font-size-20"></i></span>
					<strong class="H-font-size-12 H-display-block H-font-weight-normal H-margin-vertical-top-3">首页</strong>
				</div>
			</div>
			<div class="H-flex-item H-center-all H-padding-vertical-both-10 H-theme-border-color-white  switch-item" style="border-width: 0 0 2px  0">
				<div class="">
					<span class="H-icon H-display-block H-line-height-normal"  style="margin-left: 1px;"><i class="iconfont icon-dingdan H-font-size-20"></i></span>
					<strong class="H-font-size-12 H-display-block H-font-weight-normal H-margin-vertical-top-3">订单</strong>
				</div>
			</div>
			<div class="H-flex-item H-center-all H-padding-vertical-both-10 H-theme-border-color-white  switch-item" style="border-width: 0 0 2px  0">
				<div class="">
					<span class="H-icon H-display-block H-line-height-normal"  style="margin-left: 1px;"><i class="iconfont icon-gerenxinxi H-font-size-20"></i></span>
					<strong class="H-font-size-12 H-display-block H-font-weight-normal H-margin-vertical-top-3">我的</strong>
				</div>
			</div>
		</footer>
		<script type="text/javascript" src="../script/H.js"></script>
		<script type="text/javascript" src="../script/xy.js"></script>
		<script type="text/javascript" src="../script/zepto.min.js"></script>
		<script type="text/javascript">
			var FNScanner = null, user = null, isinerval = null;
			H.ready(function() {
				$('.brige').hide();
				//初始化极光推送
				initInfo();
				//1.3页面初始化函数
				pageInit();
				//1.4连按两次退出APP
				H.dblclickToCloseApp();
				//监听事件
				listener();
				//系统消息监听
				msglistener();
			});
			//			apiready = function() {
			//				$xy.openFrameGroupNavOrFoot(function(ret, err) {
			//					selectIndex(ret.index);
			//				}, 'groupName', [{
			//					name : 'main_index',
			//					url : './main/main_index.html',
			//					bounces : false
			//				}, {
			//					name : 'order_index',
			//					url : './order/order_index.html',
			//					bounces : true
			//				}, {
			//					name : 'me_index',
			//					url : './me/me_index.html',
			//					bounces : false
			//				}], 0, '#index_header', 'footer');
			//				//退出app
			//				$xy.dblclickToCloseApp();
			//			}
			function msglistener() {
				//系统消息处理========================
				api.addEventListener({
					name : 'noticeclicked'
				}, function(ret, err) {
					//alert(JSON.stringify(ret));
					$('.brige').show();
				});
			}

			//页面初始化函数
			function pageInit() {
				//1.2打开沉浸式页面
				H.openFrameIndexByClick([{
					name : 'main_index',
					url : './main/main_index.html',
					header : '#index_header',
					bounces : true
				}, {
					name : 'order_index',
					url : './order/order_index.html',
					header : '#massages_header',
					bounces : true
				}, {
					name : 'me_index',
					url : './me/me_index.html',
					header : '#setting_header',
					bounces : false
				}], 'H-display-none', '#index_footer', '.switch-item', 'active', 0);
			}

			//初始化用户信息
			function initInfo() {
				api.getPrefs({
					key : 'userinfo'
				}, function(ret, err) {
					if (ret && ret.value) {
						user = eval('(' + ret.value + ')');
						$xy.ajax(function(ret, err) {
							//api.hideProgress();
							if (ret.success) {
								retInfo = ret.data;
								//console.log(JSON.stringify(retInfo));
								$xy.userlogInfo(retInfo);
							} else {
								api.toast({
									msg : '您的登录状态异常'
								});
							}
						}, 'appUserInfo&funid=wash_user&wash_user_id=' + user[0].wash_user_id + '&uuid=' + user[0].uuid);
						//初始化推送监听
						pushListener();
						var ajpush = api.require('ajpush');
						//var systemtype = api.systemType;
						ajpush.setListener(function(ret) {
							//alert('接收推送成功');
							$('.brige').show();
							//					var id = ret.id;
							//					var title = ret.title;
							//					var content = ret.content;
							//					var extra = ret.extra;
						});
					} else {
					}
				});
			}

			//			function selectIndex(index) {
			//				$("#index_footer .switch-item").eq(index).addClass('active').siblings().removeClass('active');
			//				$("header").hide().eq(index).show();
			//			}
			function openWin(name, url) {
				var delay = 0;
				if (api.systemType != 'ios') {
					delay = 200;
				}
				$('.brige').hide();
				api.openWin({
					name : name,
					url : url,
					bounces : false,
					delay : delay,
					slidBackEnabled : true,
					vScrollBarEnabled : false,
					hScrollBarEnabled : false
				});
			}

			//监听推送方法
			function pushListener() {
				$xy.ajax(function(ret, err) {
					//api.hideProgress();
					if (ret.success) {
						//console.log(JSON.stringify(ret));
						for (var i = 0, len = ret.data.length; i < len; i++) {
							if (ret.data[i].is_read == "0") {
								$('.brige').show();
								return;
							}
						}
					} else {
						//console.log(JSON.stringify(ret));
						api.toast({
							msg : '服务器未响应'
						});
					}
				}, 'appUserNews&funid=wash_user_new&wash_user_id=' + user[0].wash_user_id + '&uuid=' + user[0].uuid);
			}

			//监听事件
			function listener() {
				//结束时间递减
				if (isinerval) {
					clearInterval(isinerval);
				}
				//倒计时提醒
				api.getPrefs({
					key : 'washtime'
				}, function(ret, err) {
					if (ret && ret.value) {
						//获取之前开始的时间
						var time = eval('(' + ret.value + ')');
						var stringTime = time.start_time;
						//总时间
						totalTime = parseInt(time.turn_around_date) * 60;
						//时间格式转时间戳
						var start_time = Date.parse(new Date(stringTime));
						//获取当前时间
						var now = new Date();
						//totalTime = 2;
						//计算剩余时间
						times = totalTime - ((now.getTime() - parseInt(start_time)) / 1000);
						//调用倒计时方法
						isinerval = setInterval("CountDown()", 1000);
						//渲染提示条
						var timedom = '<div class="H-text-list H-flexbox-horizontal toast_top H-vertical-middle" id="progress_toast" ><div class="H-flex-item H-font-size-12 H-padding-8 H-text-show-row-1">您正在使用的西三宿舍三楼西01机，大约<span id="minttime"></span>后结束</div></div>';
						$('#index_header').append(timedom);
						//设置定时任务
						if (times > 60) {
							var last = (totalTime - 60) * 1000;
							setTimeout(function() {
								Send_notifications();
								alert('还有' + ((totalTime - times) % 60) + '分钟结束');
							}, last);
						}
					} else {
						//隐藏提示条
						if ($("#progress_toast")) {
							$("#progress_toast").hide();
						}
					}
				});
			}

			//通知栏提醒
			function Send_notifications() {
				api.notification({
					notify : {
						title : '咭咭洗衣',
						content : '大约还有五分钟，洗衣就将结束'
					},
					light : true,
				}, function(ret, err) {
					var id = ret.id;
				});
			}

			//时间递减处理
			function CountDown() {
				//剩余时间
				var lasttime = parseInt(times / 60);
				var second = parseInt(times % 60);
				if (lasttime < 1) {
					$("#minttime").html(second + '秒');
				} else {
					$("#minttime").html(lasttime + '分钟');
				}
				if (times < 1) {
					//结束时间递减
					clearInterval(isinerval);
					//隐藏提示条
					$("#progress_toast").hide();
					//移除偏好值
					api.removePrefs({
						key : 'washtime'
					});
					return;
				}
				times--;
			}
		</script>
	</body>
</html>